<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Trajectory Analysis: Monocle3 in R</title>
        
            <script async defer data-domain="training.galaxyproject.org" src="https://plausible.galaxyproject.eu/js/plausible.js"></script>

        
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />
        <link rel="alternate" type="application/atom+xml" href="/training-material/feed.xml" />
        <link rel="canonical" href="https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html" />
        <link rel="license" href="https://creativecommons.org/licenses/by/4.0/" />

        <meta name="DC.identifier" content="https://github.com/galaxyproject/training-material" />
<meta name="DC.type" content="text" />
<meta name="DC.title" content="Trajectory Analysis: Monocle3 in R" />
<meta name="DC.publisher" content="Galaxy Training Network" />
<meta name="DC.date" content="2023-02-15 11:19:25 +0000" />
<meta name="DC.creator" content="Julia Jakiela" />

        
        
        
        
        <meta name="description" content="Training material and practicals for all kinds of single ..." />
        <meta property="og:site_name" content="Galaxy Training Network" />
        <meta property="og:title" content="Galaxy Training: Trajectory Analysis: Monocle3 in R" />
        <meta property="og:description" content="Training material and practicals for all kinds of single ..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />

        
        <script type="application/ld+json">
            


{
  "@context": "http://schema.org",
  "@type": "LearningResource",
  "http://purl.org/dc/terms/conformsTo": {
    "@id": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
    "@type": "CreativeWork"
  },
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "Students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "dateModified": "2023-02-15 11:19:25 +0000",
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Trajectory Analysis: Monocle3 in R",
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "isFamilyFriendly": true,
  "license": "https://spdx.org/licenses/CC-BY-4.0.html",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "identifier": "https://github.com/galaxyproject/training-material",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "The text aims to be as accessible as possible. Image descriptions will vary per tutorial, from images being completely inaccessible, to images with good descriptions for non-visual users.",
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Single Cell",
    "description": "Training material and practicals for all kinds of single cell analysis (particularly scRNA-seq!). When you generate your lovely gene lists for your cells, consider checking out our Transcriptomics tutorials for further network analysis!",
    "url": "https://training.galaxyproject.org/training-material/topics/single-cell/"
  },
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Trajectory Analysis: Monocle3 in R' tutorial",
  "url": "https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html",
  "timeRequired": "PT2H",
  "keywords": "single-cell, single-cell, trajectory-analysis, paper-replication, rmarkdown-notebook, jupyter-notebook",
  "description": "The questions this  addresses are:\n - How to perform a full trajectory analysis using Monocle3 in R?\n - What to do when Galaxy's Monocle tools are not enough?\n - How to assign cell types to the clusters?\n - How can I infer lineage relationships between clusters, without a time series?\n - How to perform batch correction and differential expression analysis in Monocle?\n\n\nThe objectives are:\n - Identify which operations to perform on an AnnData object to obtain the files needed for Monocle and why to do it this way\n - Become familiar with Monocle3 functions in R and be able to switch between Galaxy and R fluently\n - Learn about steps that can only be performed in R, but not with Galaxy tools\n - Follow the Monocle3 workflow and choose the right parameter values\n - Compare the outputs from Scanpy, Monocle in Galaxy and Monocle in R\n - Learn about differential expression analysis methods\n\n",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "competencyRequired": [
    {
      "@context": "http://schema.org",
      "@type": "LearningResource",
      "url": "https://training.galaxyproject.org/training-material/topics/introduction/",
      "name": "Introduction to Galaxy Analyses",
      "description": "Introduction to Galaxy Analyses",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@context": "http://schema.org",
      "@type": "LearningResource",
      "url": "https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-case_alevin/tutorial.html",
      "name": "Generating a single cell matrix using Alevin",
      "description": "Hands-on for 'Generating a single cell matrix using Alevin' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@context": "http://schema.org",
      "@type": "LearningResource",
      "url": "https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-case_alevin-combine-datasets/tutorial.html",
      "name": "Combining datasets after pre-processing",
      "description": "Hands-on for 'Combining datasets after pre-processing' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@context": "http://schema.org",
      "@type": "LearningResource",
      "url": "https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-case_basic-pipeline/tutorial.html",
      "name": "Filter, Plot and Explore Single-cell RNA-seq Data",
      "description": "Hands-on for 'Filter, Plot and Explore Single-cell RNA-seq Data' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@context": "http://schema.org",
      "@type": "LearningResource",
      "url": "https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-case_JUPYTER-trajectories/tutorial.html",
      "name": "Inferring Trajectories using Python (Jupyter Notebook) in Galaxy",
      "description": "Hands-on for 'Inferring Trajectories using Python (Jupyter Notebook) in Galaxy' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@context": "http://schema.org",
      "@type": "LearningResource",
      "url": "https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-case_monocle3-trajectories/slides.html",
      "name": "Trajectory analysis",
      "description": "Slides for 'Trajectory analysis' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@context": "http://schema.org",
      "@type": "LearningResource",
      "url": "https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-case_monocle3-trajectories/tutorial.html",
      "name": "Trajectory Analysis using Monocle3 ",
      "description": "Hands-on for 'Trajectory Analysis using Monocle3 ' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Single Cell",
      "description": "Training material and practicals for all kinds of single cell analysis (particularly scRNA-seq!). When you generate your lovely gene lists for your cells, consider checking out our Transcriptomics tutorials for further network analysis!",
      "url": "https://training.galaxyproject.org/training-material/topics/single-cell/"
    }
  ]
}
        </script>
        
    </head>
    <body data-spy="scroll" data-target="#toc">
        <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>
        <header>
    <nav class="navbar navbar-expand-md navbar-dark" aria-label="Site Navigation">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        
                        <a class="nav-link" href="/training-material/topics/single-cell" title="Go back to list of tutorials">
                            <i class="far fa-folder" aria-hidden="true"></i> Single Cell
                        </a>
                        
                    </li>

                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Languages">
                            <i class="fas fa-language" aria-hidden="true"></i><span class="visually-hidden">language</span> Languages
                        </a>
                        <div class="dropdown-menu dropdown-menu-right">
                            
                              <strong class="dropdown-header">Automatic Translations</strong>
            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html&edit-text=&act=url">
                            Fran√ßais
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html&edit-text=&act=url">
                            Êó•Êú¨Ë™û
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html&edit-text=&act=url">
                            Espa√±ol
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html&edit-text=&act=url">
                            Portugu√™s
                            </a>
                            
            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html&edit-text=&act=url">
                            ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html&edit-text=&act=url" title="">
                            And more!
                            </a>
                        </div>
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <!-- disable Tess for now
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>
        -->

        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQs">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> FAQs
        </a>
        
        
        <a class="dropdown-item" href="/training-material/topics/single-cell/faqs/" title="Check our FAQs for the Single Cell topic">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Topic FAQs
        </a>
        
        
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            <i class="far fa-comments" aria-hidden="true"></i><span class="visually-hidden">feedback</span> Galaxy Help Forum
        </a>
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Discuss on gitter">
           <i class="fab fa-gitter" aria-hidden="true"></i><span class="visually-hidden">gitter</span> Discuss on Gitter
        </a>
    </div>
</li>


                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Extras">
        <i class="far fa-star" aria-hidden="true"></i><span class="visually-hidden">galaxy-star</span> Extras
    </a>
    <div class="dropdown-menu dropdown-menu-right">

        
        <a class="dropdown-item" href="https://github.com/galaxyproject/training-material/edit/main/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.md" title="Edit on GitHub">
          <i class="fab fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit on GitHub
        </a>

        <a class="dropdown-item" href="/training-material/stats.html" title="Show view statistics about this repository">
            <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN statistics
        </a>

        <a class="dropdown-item" href="https://plausible.galaxyproject.eu/training.galaxyproject.org?period=12mo&page=/training-material/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html" title="Show view statistics of this page">
            <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> Page Metrics
        </a>

        <!-- link to feedback -->
        
            
            
                <a class="dropdown-item" href="/training-material/feedback.html" title="Show feedback statistics about this repository">
                    <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN feedback
                </a>
            
        

        <div class="dropdown-item">
            <div>
                <i class="fas fa-palette" aria-hidden="true"></i><span class="visually-hidden">gtn-theme</span> Theme
            </div>

            <div id="theme-selector" data-toggle="buttons">
                    <button class="btn" data-theme="default">Default</button>
                    <button class="btn" data-theme="night">Night</button>
                    <button class="btn" data-theme="midnight">Midnight</button>
                    <button class="btn" data-theme="rainbow">Rainbow</button>
                    <button class="btn" data-theme="blm">‚úäüèø</button>
                    <button class="btn" data-theme="progress" >üè≥Ô∏è‚Äçüåà</button>
                    <button class="btn" data-theme="halloween">üéÉ</button>
                    <button class="btn" data-theme="straya">üá¶üá∫</button>
            </div>

        </div>

        <div class="dropdown-item">
            <div>
                <i class="fas fa-history" aria-hidden="true"></i><span class="visually-hidden">galaxy-rulebuilder-history</span> Previous Versions
            </div>

            <div id="archive-selector">
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/2020-01-06/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html" title="Version 2020-01-06">2020-01-06</a>
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/2019-12-01/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html" title="Version 2019-12-01">2019-12-01</a>
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/2019-11-01/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html" title="Version 2019-11-01">2019-11-01</a>
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/" title="Older Versions">Older Versions</a>
            </div>

        </div>

    </div>
</li>


                    <!-- Search bar-->
                    <li class="nav-item">
                      <div id="navbarSupportedContent" role="search">
                        <!-- Search form -->
                        <form class="form-inline mr-auto" method="GET" action="/training-material/search">
                          <i class="fas fa-search nav-link" aria-hidden="true"></i>
                          <div class="md-form mb-2">
                            <input name="query" class="form-control nicer" type="text" placeholder="Search Tutorials" aria-label="Search">
                          </div>
                        </form>
                      </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

        <div class="container main-content" role="main">
        











<!-- Gitter -->




<script>
  ((window.gitter = {}).chat = {}).options = {
  room: 'Galaxy-Training-Network/Lobby'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

<section class="tutorial topic-single-cell">
    <h1 data-toc-skip>Trajectory Analysis: Monocle3 in R</h1>
    

    <div markdown="0">

	<div class="contributors-line">
		
<table class="contributions">
	
	<tr>
		<td><abbr title="These people wrote the bulk of the tutorial, they may have done the analysis, built the workflow, and wrote the text themselves.">Author(s)</abbr></td>
		<td>
			<a href="/training-material/hall-of-fame/wee-snufkin/" class="contributor-badge contributor-wee-snufkin"><img src="https://avatars.githubusercontent.com/wee-snufkin?s=27" alt="Avatar">Julia Jakiela</a>
		</td>
	</tr>
	


	

	
	<tr>
		<td><abbr title="These people edited the text, either for spelling and grammar, flow, GTN-fit, or other similar editing categories">Editor(s)</abbr></td>
		<td>
			<a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge contributor-hexylena"><img src="/training-material/assets/images/orcid.png" alt="orcid logo"/><img src="https://avatars.githubusercontent.com/hexylena?s=27" alt="Avatar">Helena Rasche</a></td>
	</tr>
	

	

	

	
</table>


	</div>

</div>


    <blockquote class="overview">
        <div class="box-title" aria-label="overview box">Overview</div>
        
        <img alt="Creative Commons License" class="float-right" style="border-width:0; display: inline-block; margin:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" aria-hidden="true" />
        
        <strong><i class="far fa-question-circle" aria-hidden="true"></i> Questions:</strong>
        <ul>
        
        <li><p>How to perform a full trajectory analysis using Monocle3 in R?</p>
</li>
        
        <li><p>What to do when Galaxy‚Äôs Monocle tools are not enough?</p>
</li>
        
        <li><p>How to assign cell types to the clusters?</p>
</li>
        
        <li><p>How can I infer lineage relationships between clusters, without a time series?</p>
</li>
        
        <li><p>How to perform batch correction and differential expression analysis in Monocle?</p>
</li>
        
        </ul>

        <strong><i class="fas fa-bullseye" aria-hidden="true"></i> Objectives: </strong>
        <ul>
        
        <li><p>Identify which operations to perform on an AnnData object to obtain the files needed for Monocle and why to do it this way</p>
</li>
        
        <li><p>Become familiar with Monocle3 functions in R and be able to switch between Galaxy and R fluently</p>
</li>
        
        <li><p>Learn about steps that can only be performed in R, but not with Galaxy tools</p>
</li>
        
        <li><p>Follow the Monocle3 workflow and choose the right parameter values</p>
</li>
        
        <li><p>Compare the outputs from Scanpy, Monocle in Galaxy and Monocle in R</p>
</li>
        
        <li><p>Learn about differential expression analysis methods</p>
</li>
        
        </ul>

        
        <strong><i class="fas fa-check-circle" aria-hidden="true"></i> Requirements:</strong>
        <ul>
        
    <li>
    
        
        
        <a href="/training-material/topics/introduction">Introduction to Galaxy Analyses</a>
        
    
    </li>

        
    <li>
    
        
        
        <a href="/training-material/topics/single-cell">Single Cell</a>
        
            <ul>
                
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Generating a single cell matrix using Alevin:
                            
                            
                                
                                     <a href="/training-material/topics/single-cell/tutorials/scrna-case_alevin/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Combining datasets after pre-processing:
                            
                            
                                
                                     <a href="/training-material/topics/single-cell/tutorials/scrna-case_alevin-combine-datasets/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Filter, Plot and Explore Single-cell RNA-seq Data:
                            
                            
                                
                                     <a href="/training-material/topics/single-cell/tutorials/scrna-case_basic-pipeline/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Inferring Trajectories using Python (Jupyter Notebook) in Galaxy:
                            
                            
                                
                                     <a href="/training-material/topics/single-cell/tutorials/scrna-case_JUPYTER-trajectories/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Trajectory Analysis using Monocle3 :
                            
                                <a href="/training-material/topics/single-cell/tutorials/scrna-case_monocle3-trajectories/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/single-cell/tutorials/scrna-case_monocle3-trajectories/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                
            </ul>
        
    
    </li>

        </ul>
        

        
        <div><strong><i class="fas fa-hourglass-half" aria-hidden="true"></i> Time estimation:</strong> 2 hours</div>
        

        

        
        

        
        <div id="supporting-materials"><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials:</strong></div>
        <ul class="supporting_material">
            

            
                <li class="btn btn-default supporting_material">


<a class="btn btn-default topic-icon" title="Zenodo datasets used in this tutorial" href="https://zenodo.org/record/7455590">
    <i class="far fa-copy" aria-hidden="true"></i>&nbsp;Datasets
</a>

</li>
            

            
                <li class="btn btn-default supporting_material">


    <a class="btn btn-default topic-icon" href="/training-material/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/workflows/" title="Workflows" alt="Trajectory Analysis: Monocle3 in R workflows">
        <i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Workflows
    </a>

</li>
            

            

            
                <li class="btn btn-default supporting_material">


    <a class="topic-icon" href="/training-material/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/single-cell-scrna-case_monocle3-rstudio.ipynb" title="Jupyter Notebook" alt="Trajectory Analysis: Monocle3 in R Notebook">
        <i class="far fa-file-code" aria-hidden="true"></i> Jupyter Notebook
    </a>
    
        <a class="topic-icon" href="/training-material/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/single-cell-scrna-case_monocle3-rstudio.Rmd" title="R markdown notebook" alt="Trajectory Analysis: Monocle3 in R Notebook">
            <i class="far fa-file-code" aria-hidden="true"></i> RMarkdown Notebook
        </a>
    

</li>
            

            
            
            
                 <li class="btn btn-default supporting_material">
    <a class="topic-icon" href="/training-material/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/faqs/" title="Frequently Asked Questions" alt="Tutorial FAQs">
        <i class="far fa-question-circle" aria-hidden="true"></i> FAQs
    </a>
  </li>


            

            <!-- Check the GTN Video Library for recordings of this tutorial or associated slides -->
            













  



            
                <li class="btn btn-default supporting_material">


    <a href="#" class="btn btn-default dropdown-toggle topic-icon" data-toggle="dropdown" aria-expanded="false" title="Where to run the tutorial">
        <i class="fas fa-globe" aria-hidden="true"></i><span class="visually-hidden">instances</span>&nbsp;Available on these Galaxies 
    </a>
    <ul class="dropdown-menu">
    
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
        <a class="dropdown-item" href="https://africa.usegalaxy.eu/" title="Galaxy Africa">
            Galaxy Africa
        </a>
        
    
        
        <a class="dropdown-item" href="https://india.usegalaxy.eu/" title="Galaxy India">
            Galaxy India
        </a>
        
    
        
    
        
        <a class="dropdown-item" href="https://test.galaxyproject.org/" title="Galaxy Test">
            Galaxy Test
        </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
        <a class="dropdown-item" href="https://humancellatlas.usegalaxy.eu/" title="Human Cell Atlas">
            Human Cell Atlas
        </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
        <a class="dropdown-item" href="https://plants.usegalaxy.eu/" title="Plant Anaylsis Workbench">
            Plant Anaylsis Workbench
        </a>
        
    
        
    
        
    
        
        <a class="dropdown-item" href="https://singlecell.usegalaxy.eu/" title="Single Cell Omics workbench">
            Single Cell Omics workbench
        </a>
        
    
        
        <a class="dropdown-item" href="https://streetscience.usegalaxy.eu/" title="Street Science">
            Street Science
        </a>
        
    
        
        <a class="dropdown-item" href="https://usegalaxy.be/" title="UseGalaxy.be">
            UseGalaxy.be
        </a>
        
    
        
        <a class="dropdown-item" href="https://usegalaxy.eu" title="UseGalaxy.eu">
            UseGalaxy.eu
        </a>
        
    
        
    
        
        <a class="dropdown-item" href="https://usegalaxy.no/" title="UseGalaxy.no">
            UseGalaxy.no
        </a>
        
    
        
        <a class="dropdown-item" href="https://usegalaxy.org" title="UseGalaxy.org (Main)">
            UseGalaxy.org (Main)
        </a>
        
    
        
        <a class="dropdown-item" href="https://usegalaxy.org.au" title="UseGalaxy.org.au">
            UseGalaxy.org.au
        </a>
        
    
        
    
        
    
        
    
        
    
    </ul>


</li>
            
        </ul>
        

        <div><strong><i class="far fa-calendar" aria-hidden="true"></i> Last modification:</strong> Feb 15, 2023 </div>
        <div><strong><i class="fas fa-balance-scale" aria-hidden="true"></i> License:</strong>
            
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Tutorial Content is licensed under Creative Commons Attribution 4.0 International License</a>
            
            <a rel="license" href="https://github.com/galaxyproject/training-material/blob/main/LICENSE.md">The GTN Framework is licensed under MIT</a>
        </div>
    </blockquote>

    <div class="container">
        <div class="row">
            <!-- sidebar, which will move to the top on a small screen -->
            <div class="col-sm-2">
                <nav id="toc" data-toggle="toc" class="sticky-top" aria-label="Table of Contents"></nav>
            </div>
            <div class="col-sm-10">
                 
                     
                     
                     
                     
                    
                        
                        <!--SNIPPET--><h1 id="introduction">Introduction</h1> <p>You‚Äôve done all the hard work of preparing a single cell matrix, processing it, plotting it, interpreting it, finding lots of lovely genes, all within the glorious Galaxy interface. Now you want to infer trajectories, or relationships between cells‚Ä¶ and you‚Äôve been threatened with learning Python to do so! Well, fear not. If you can have a run-through of a basic python coding introduction such as <a href="https://www.w3schools.com/python/">this one</a>, then that will help you make more sense of this tutorial, however you‚Äôll be able to make and interpret glorious plots even without understanding the Python coding language. This is the beauty of Galaxy - all the ‚Äòset-up‚Äô is identical across computers, because it‚Äôs browser based. So fear not!</p> <p>Traditionally, we thought that differentiating or changing cells jumped between discrete states, so ‚ÄòCell A‚Äô became ‚ÄòCell B‚Äô as part of its maturation. However, most data shows otherwise, that generally there is a spectrum (a ‚Äòtrajectory‚Äô, if you will‚Ä¶) of small, subtle changes along a pathway of that differentiation. Trying to analyse cells every 10 seconds can be pretty tricky, so ‚Äòpseudotime‚Äô analysis takes a single sample and assumes that those cells are all on slightly different points along a path of differentiation. Some cells might be slightly more mature and others slightly less, all captured at the same ‚Äòtime‚Äô. We ‚Äòassume‚Äô or ‚Äòinfer‚Äô relationships between cells.</p> <p>We will use the same sample from the previous three tutorials, which contains largely T-cells in the thymus. We know T-cells differentiate in the thymus, so we would assume that we would capture cells at slightly different time points within the same sample. Furthermore, our cluster analysis alone showed different states of T-cell. Now it‚Äôs time to look further!</p> <blockquote class="agenda">   <div class="box-title agenda-title" id="agenda" aria-label="agenda box: ">Agenda</div>   <p>In this tutorial, we will cover:</p> <ol id="markdown-toc">   <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a>    <ol>       <li><a href="#get-data" id="markdown-toc-get-data">Get data</a></li>       <li><a href="#filtering-for-t-cells" id="markdown-toc-filtering-for-t-cells">Filtering for T-cells</a></li>       <li><a href="#launching-jupyter" id="markdown-toc-launching-jupyter">Launching Jupyter</a></li>     </ol>   </li> </ol> </blockquote> <h2 id="get-data">Get data</h2> <p>We‚Äôve provided you with experimental data to analyse from a mouse dataset of fetal growth restriction <span class="citation"><a href="#Bacon2018">Bacon <i>et al.</i> 2018</a></span>. This is the full dataset generated from <a href="/training-material/topics/single-cell/tutorials/scrna-case_basic-pipeline/tutorial.html">this tutorial</a> (see the <a href="https://www.ebi.ac.uk/gxa/sc/experiments/E-MTAB-6945/results/tsne">study in Single Cell Expression Atlas</a> and the <a href="https://www.ebi.ac.uk/arrayexpress/experiments/E-MTAB-6945/">project submission</a>). You can find the final dataset in this <a href="https://usegalaxy.eu/u/wendi.bacon.training/h/cs4inferred-trajectory-analysis-using-python-jupyter-notebook-in-galaxy---input">input history</a> or download from Zenodo below.</p> <blockquote class="hands_on">   <div class="box-title hands-on-title" id="hands-on-data-upload" aria-label="hands-on box: Data upload"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden"></span> Hands-on: Data upload</div>   <ol>     <li>Create a new history for this tutorial</li>     <li>       <p>Import the AnnData object from <a href="https://zenodo.org/record/7455590">Zenodo</a></p>       <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://zenodo.org/record/7455590/files/Trajectories_Instructions.ipynb<br>https://zenodo.org/record/7455590/files/Final_cell_annotated_object.h5ad<br></code></pre></div>      </div>       <!--SNIPPET-->       <blockquote class="tip">   <div class="box-title tip-title" id="tip-importing-via-links"><button class="gtn-boxify-button tip" type="button" aria-controls="tip-importing-via-links-contents" aria-expanded="true" aria-label="Toggle tip box: Importing via links"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden"></span> Tip: Importing via links<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>   <ul>   <li>Copy the link location</li>   <li>     <p>Open the Galaxy Upload Manager (<i class="fas fa-upload" aria-hidden="true"></i><span class="visually-hidden">galaxy-upload</span> on the top-right of the tool panel)</p>   </li>   <li>Select <strong>Paste/Fetch Data</strong></li>   <li>     <p>Paste the link into the text field</p>   </li>   <li>     <p>Press <strong>Start</strong></p>   </li>   <li><strong>Close</strong> the window</li> </ul> </blockquote>     </li>     <li>       <p><strong>Rename</strong> <i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">galaxy-pencil</span> the .h5ad object as <code class="language-plaintext highlighter-rouge">Final cell annotated object</code></p>       <!--SNIPPET-->       <blockquote class="tip">   <div class="box-title tip-title" id="tip-renaming-a-dataset"><button class="gtn-boxify-button tip" type="button" aria-controls="tip-renaming-a-dataset-contents" aria-expanded="true" aria-label="Toggle tip box: Renaming a dataset"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden"></span> Tip: Renaming a dataset<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>   <ul>   <li>Click on the <i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">galaxy-pencil</span> <strong>pencil icon</strong> for the dataset to edit its attributes</li>   <li>In the central panel, change the <strong>Name</strong> field  to <code class="language-plaintext highlighter-rouge">Final cell annotated object</code></li>   <li>Click the <strong>Save</strong> button</li> </ul> </blockquote>     </li>     <li>       <p>Check that the datatype is <code class="language-plaintext highlighter-rouge">h5ad</code></p>       <!--SNIPPET-->       <blockquote class="tip">   <div class="box-title tip-title" id="tip-changing-the-datatype"><button class="gtn-boxify-button tip" type="button" aria-controls="tip-changing-the-datatype-contents" aria-expanded="true" aria-label="Toggle tip box: Changing the datatype"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden"></span> Tip: Changing the datatype<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>   <ul>   <li>Click on the <i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">galaxy-pencil</span> <strong>pencil icon</strong> for the dataset to edit its attributes</li>   <li>In the central panel, click on the <i class="fas fa-database" aria-hidden="true"></i><span class="visually-hidden">galaxy-chart-select-data</span> <strong>Datatypes</strong> tab on the top</li>   <li>Select <code class="language-plaintext highlighter-rouge">h5ad</code>     <ul>       <li>tip: you can start typing the datatype into the field to filter the dropdown menu</li>     </ul>   </li>   <li>Click the <strong>Save</strong> button</li> </ul> </blockquote>     </li>     <li>       <p><strong>Rename</strong> <i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">galaxy-pencil</span> the .ipynb object as <code class="language-plaintext highlighter-rouge">Trajectories_Instructions.ipynb</code></p>     </li>     <li>Check that the datatype is <code class="language-plaintext highlighter-rouge">.ipynb</code></li>   </ol> </blockquote> <h2 id="filtering-for-t-cells">Filtering for T-cells</h2> <p>One problem with our current dataset is that it‚Äôs not just T-cells: we found in the previous tutorial that it also contains macrophages. This is a problem, because trajectory analysis will generally try to find relationships between all the cells in the sample. We need to remove those cell types to analyse the trajectory.</p> <!--SNIPPET--> <blockquote class="tip">   <div class="box-title tip-title" id="tip-using-tutorial-mode"><button class="gtn-boxify-button tip" type="button" aria-controls="tip-using-tutorial-mode-contents" aria-expanded="true" aria-label="Toggle tip box: Using tutorial mode"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden"></span> Tip: Using tutorial mode<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>   <p>Tools are frequently updated to new versions. Your Galaxy may have multiple versions of the same tool available. By default, you will be shown the latest version of the tool. This may NOT be the same tool used in the tutorial you are accessing. Furthermore, if you use a newer tool in one step, and try using an older tool in the next step‚Ä¶ this may fail! To ensure you use the same tool versions of a given tutorial, use the <strong>Tutorial mode</strong> feature.</p>   <ul>   <li>Open your Galaxy server</li>   <li>Click on the <i class="fas fa-graduation-cap" aria-hidden="true"></i><span class="visually-hidden">curriculum</span> icon on the top menu, this will open the GTN inside Galaxy.</li>   <li>Navigate to your tutorial</li>   <li>Tool names in tutorials will be blue buttons that open the correct tool for you</li>   <li><strong>Note:</strong> this does not work for all tutorials (yet)   <img src="/training-material/topics/contributing/images/88277962-ddda4a80-cce1-11ea-92cd-41b1df063db0.gif" alt="gif showing how GTN-in-Galaxy works" /></li>   <li>You can click anywhere in the grey-ed out area outside of the tutorial box to return back to the Galaxy analytical interface</li> </ul>   <blockquote class="warning">   <div class="box-title warning-title" id="warning-not-all-browsers-work" aria-label="warning box: Not all browsers work!"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i><span class="visually-hidden"></span> Warning: Not all browsers work!</div>   <ul>     <li>We‚Äôve had some issues with Tutorial mode on Safari for Mac users.</li>     <li>Try a <strong>different browser</strong> if you aren‚Äôt seeing the button.</li>   </ul> </blockquote> </blockquote> <blockquote class="hands_on">   <div class="box-title hands-on-title" id="hands-on-removing-macrophages" aria-label="hands-on box: Removing macrophages"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden"></span> Hands-on: Removing macrophages</div>   <ol>     <li><span class="tool" data-tool="toolshed.g2.bx.psu.edu/repos/iuc/anndata_manipulate/anndata_manipulate/0.7.5+galaxy1" title="Tested with toolshed.g2.bx.psu.edu/repos/iuc/anndata_manipulate/anndata_manipulate/0.7.5+galaxy1"><strong>Manipulate AnnData</strong> <i class="fas fa-wrench" aria-hidden="true"></i><i aria-hidden="true" class="fas fa-cog"></i><span class="visually-hidden">Tool: toolshed.g2.bx.psu.edu/repos/iuc/anndata_manipulate/anndata_manipulate/0.7.5+galaxy1</span></span>  with the following parameters:       <ul>         <li><i class="far fa-file" aria-hidden="true"></i><span class="visually-hidden">param-file</span> <em>‚ÄúAnnotated data matrix‚Äù</em>: <code class="language-plaintext highlighter-rouge">Final cell annotated object</code></li>         <li><em>‚ÄúFunction to manipulate the object‚Äù</em>: <code class="language-plaintext highlighter-rouge">Filter observations or variables</code></li>         <li><em>‚ÄúWhat to filter?‚Äù</em>: <code class="language-plaintext highlighter-rouge">Observations (obs)</code></li>         <li><em>‚ÄúType of filtering?‚Äù</em>: <code class="language-plaintext highlighter-rouge">By key (column) values</code></li>         <li><em>‚ÄúKey to filter‚Äù</em>: <code class="language-plaintext highlighter-rouge">cell_type</code></li>         <li><em>‚ÄúType of value to filter‚Äù</em>: <code class="language-plaintext highlighter-rouge">Text</code></li>         <li><em>‚ÄúFilter‚Äù</em>: <code class="language-plaintext highlighter-rouge">not equal to</code></li>         <li><em>‚ÄúValue‚Äù</em>: <code class="language-plaintext highlighter-rouge">Macrophages</code></li>       </ul>     </li>     <li><strong>Rename</strong> <i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">galaxy-pencil</span> output h5ad <code class="language-plaintext highlighter-rouge">T-cell_object.h5ad</code></li>   </ol> </blockquote> <p>You should now have <code class="language-plaintext highlighter-rouge">8569</code> cells, as opposed to the <code class="language-plaintext highlighter-rouge">8605</code> you started with. You‚Äôve only removed a few cells (the contaminants!), but it makes a big difference in the next steps.</p> <p>Take note of what # this dataset is in your history, as you will need that shortly!</p> <h2 id="launching-jupyter">Launching Jupyter</h2> <blockquote class="warning">   <div class="box-title warning-title" id="warning-data-uploads-and-jupyter" aria-label="warning box: Data uploads and Jupyter"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i><span class="visually-hidden"></span> Warning: Data uploads and Jupyter</div>   <p>There are a few ways of importing and uploading data in Jupyter. You might find yourself accidentally doing this differently than the tutorial, and that‚Äôs ok. There are a few key steps where you will call files from a location - if these don‚Äôt work from you, check that the file location is correct and change accordingly!</p> </blockquote> <p>JupyterLab is a bit like RStudio but for other coding languages. What, you‚Äôve never heard of <a href="https://www.rstudio.com/products/rstudio/features/">RStudio</a>? Then don‚Äôt worry, just follow the instructions!</p> <p><i class="fas fa-exclamation-triangle" aria-hidden="true"></i><span class="visually-hidden">warning</span> Please note: this is only currently available on the <a href="https://usegalaxy.eu">usegalaxy.eu</a> and <a href="https://usegalaxy.org">usegalaxy.org</a> sites.</p> <blockquote class="hands_on">   <div class="box-title hands-on-title" id="hands-on-downloading-the-tutorial-notebook" aria-label="hands-on box: Downloading the tutorial notebook"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden"></span> Hands-on: Downloading the tutorial notebook</div>   <ol>     <li>You will need to download the tutorial notebook locally to your own computer. Do this by clicking on <i class="far fa-file-code" aria-hidden="true"></i><span class="visually-hidden">notebook</span><code class="language-plaintext highlighter-rouge">Jupyter notebook</code> in the <code class="language-plaintext highlighter-rouge">Supporting Materials</code> section at the very beginning of the tutorial, in the Overview box.</li>   </ol> </blockquote> <blockquote class="hands_on">   <div class="box-title hands-on-title" id="hands-on-launching-jupyterlab" aria-label="hands-on box: Launching JupyterLab"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden"></span> Hands-on: Launching JupyterLab</div>   <ol>     <li><span class="tool" data-tool="interactive_tool_jupyter_notebook" title="Tested with interactive_tool_jupyter_notebook"><strong>Interactive JupyTool and Notebook</strong> <i class="fas fa-wrench" aria-hidden="true"></i><i aria-hidden="true" class="fas fa-cog"></i><span class="visually-hidden">Tool: interactive_tool_jupyter_notebook</span></span>  with the following parameters:       <ul>         <li><em>‚ÄúDo you already have a notebook?‚Äù</em>: <code class="language-plaintext highlighter-rouge">Start with a fresh notebook</code></li>       </ul>       <p>This may take a moment, but once the <code class="language-plaintext highlighter-rouge">Executed notebook</code> in your dataset is orange, you are up and running!</p>     </li>     <li>       <p>Either click on the blue <code class="language-plaintext highlighter-rouge">User menu</code>, or go to the top of the screen and choose <code class="language-plaintext highlighter-rouge">User</code> and then <code class="language-plaintext highlighter-rouge">Active InteractiveTools</code></p>     </li>     <li>Click on the newest <code class="language-plaintext highlighter-rouge">JupyTool interactive tool</code>.</li>   </ol> </blockquote> <p>Welcome!</p> <blockquote class="warning">   <div class="box-title warning-title" id="warning-danger-you-can-lose-data" aria-label="warning box: Danger: You can lose data!"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i><span class="visually-hidden"></span> Warning: Danger: You can lose data!</div>   <p>Do NOT delete or close this notebook dataset in your history. YOU WILL LOSE IT!</p> </blockquote> <blockquote class="hands_on">   <div class="box-title hands-on-title" id="hands-on-creating-a-notebook" aria-label="hands-on box: Creating a notebook"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden"></span> Hands-on: Creating a notebook</div>   <ol>     <li>Click the <strong>Python 3</strong> icon under <strong>Notebook</strong></li>   </ol>   <p><img src="../../images/scrna-casestudy/wab-python3logo.png" alt="Python 3 icon" title="Python 3 Button" /></p>   <ol>     <li>       <p>Save your file (<strong>File</strong>: <strong>Save</strong>, or click the <i class="far fa-save" aria-hidden="true"></i><span class="visually-hidden">galaxy-save</span> Save icon at the top left)</p>     </li>     <li>       <p>If you right click on the file in the folder window at the left, you can rename your file <code class="language-plaintext highlighter-rouge">whateveryoulike.ipynb</code></p>     </li>   </ol> </blockquote> <p>Cool! Now you know how to create a file! Helpfully, however, we have created one for you, and you‚Äôve downloaded it onto your computer already!</p> <blockquote class="hands_on">   <div class="box-title hands-on-title" id="hands-on-uploading-the-tutorial-notebook" aria-label="hands-on box: Uploading the tutorial notebook"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden"></span> Hands-on: Uploading the tutorial notebook</div>   <ol>     <li>       <p>In the folder window, <i class="fas fa-upload" aria-hidden="true"></i><span class="visually-hidden">galaxy-upload</span> Upload the downloaded notebook from your computer. It should appear in the file window.</p>     </li>     <li>       <p>Open it by double clicking it in the file window.</p>     </li>   </ol> </blockquote> <blockquote class="warning">   <div class="box-title warning-title" id="warning-you-should-b-save-b-frequently" aria-label="warning box: You should <b>Save</b> frequently!"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i><span class="visually-hidden"></span> Warning: You should <b>Save</b> frequently!</div>   <p>This is both for good practice and to protect you in case you accidentally close the browser. Your environment will still run, so it will contain the last saved notebook you have. You might eventually stop your environment after this tutorial, but ONLY once you have saved and exported your notebook (more on that at the end!) Note that you can have multiple notebooks going at the same time within this JupyterLab, so if you do, you will need to save and export each individual notebook. You can also download them at any time.</p> </blockquote> 
                    
                 

                <h2 id="files-upload">Files upload</h2>

<p>While the installation in running in the Terminal tab, you can work on other things in JupyterLab. Let‚Äôs upload the files you downloaded from <span class="notranslate">Galaxy</span>: the notebook and three data files - cell annotations, gene annotations and unprocessed <span class="notranslate">expression</span> matrix.</p>

<blockquote class="notranslate hands_on">
  <div class="box-title hands-on-title" id="hands-on-files-upload" aria-label="hands-on box: Files upload"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden"></span> Hands-on: Files upload</div>

  <ol>
    <li>In the folder window, Upload the <code class="language-plaintext highlighter-rouge"><span class="notranslate">single-cell</span>-sc<span class="notranslate">rna</span>-case_monocle3-rstudio.ipynb</code> and three data files that you had downloaded from your computer.</li>
  </ol>
  <figure id="figure-1"><img src="../../images/scrna-casestudy-monocle/upload_notebook.jpg" alt="Screenshot of the folder window in JupyterLab, highlighting 'Upload' button." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 1:</span> Click here to upload the files.</figcaption></figure>

  <ol>
    <li>Right-click on the files and rename them so that it‚Äôs easier to refer to them:
      <ul>
        <li><code class="language-plaintext highlighter-rouge"><span class="notranslate">Galaxy</span>X-[Extracted_cell_annotations_(obs)]</code> to <code class="language-plaintext highlighter-rouge">cells</code></li>
        <li><code class="language-plaintext highlighter-rouge"><span class="notranslate">Galaxy</span>X-[Extracted gene annotations (var)]</code> to <code class="language-plaintext highlighter-rouge">genes</code></li>
        <li><code class="language-plaintext highlighter-rouge"><span class="notranslate">Galaxy</span>X-[Unprocessed <span class="notranslate">expression</span> matrix]</code> to <code class="language-plaintext highlighter-rouge"><span class="notranslate">expression</span></code></li>
      </ul>
    </li>
    <li>Open the notebook by double clicking it in the file window.</li>
  </ol>

</blockquote>

<p>From now on, you can switch to the notebook you just opened in JuyterLab and follow the tutorial in there!</p>

<h2 id="setting-the-environment">Setting the environment</h2>
<p>Once the installation is done, we should load the needed packages into our notebook.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">monocle3</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">biomaRt</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">Rcpp</span><span class="p">)</span><span class="w">         </span><span class="c1"># needed for reduce_dimension to avoid AnnoyAngular error</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">magrittr</span><span class="p">)</span><span class="w">     </span><span class="c1"># needed for %&gt;%</span><span class="w">
</span></code></pre></div></div>
<p>Alright, the libraries are here - so now let‚Äôs read in our data files.</p>

<blockquote class="question">
  <div class="box-title question-title" id="question" aria-label="question box: "><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden"></span> Question</div>

  <p>What is the datatype of the uploaded files?</p>

  <blockquote class="solution">
    <div class="box-title solution-title" id="solution"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

    <p>If you first downloaded the files from <span class="notranslate">Galaxy</span> and then uploaded them into RStudio, you should be able to see the extension <code class="language-plaintext highlighter-rouge">.tabular</code>. You might not see it if you fetched data directly from your history, but you can easily check the type of data in <span class="notranslate">Galaxy</span>, and - what‚Äôs more - change it there. But today we‚Äôre focusing on coding!</p>

  </blockquote>

</blockquote>

<p>As mentioned above, the datatype of our files is tabular, so we will use <code class="language-plaintext highlighter-rouge">read.delim()</code> function to read them in. In this function, the first argument is the file path - in our case, the files are in the same folder as the notebook, so the file path is the same as the file name. You can always check that by right-clicking on the file and choosing <code class="language-plaintext highlighter-rouge">Copy path</code>. The second argument, <code class="language-plaintext highlighter-rouge">row.names=1</code> takes the column number of the data file from which to take the row names.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># read in the files</span><span class="w">
</span><span class="n">cell_metadata</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.delim</span><span class="p">(</span><span class="s1">'cells.tabular'</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="n">gene_metadata</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.delim</span><span class="p">(</span><span class="s1">'genes.tabular'</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w">
</span><span class="n"><span class="notranslate">expression</span>_matrix</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.delim</span><span class="p">(</span><span class="s1">'<span class="notranslate">expression</span>.tabular'</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<blockquote class="question">
  <div class="box-title question-title" id="question-1" aria-label="question box: "><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden"></span> Question</div>

  <p>Why should we set <code class="language-plaintext highlighter-rouge">row.names=1</code>?</p>

  <blockquote class="solution">
    <div class="box-title solution-title" id="solution-1"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-1-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

    <p>This allows us to ensure that the <span class="notranslate">expression</span> value matrix has the same number of columns as the <code class="language-plaintext highlighter-rouge">cell_metadata</code> has rows and the same number of rows as the <code class="language-plaintext highlighter-rouge">gene_metadata</code> has rows. Importantly, row names of the <code class="language-plaintext highlighter-rouge">cell_metadata</code> object should match the column names of the <span class="notranslate">expression</span> matrix and row names of the <code class="language-plaintext highlighter-rouge">gene_metadata</code> object should match row names of the <span class="notranslate">expression</span> matrix.</p>

  </blockquote>

</blockquote>

<blockquote class="tip">
  <div class="box-title tip-title" id="tip-reading-in-the-files-for-rstudio-users"><button class="gtn-boxify-button tip" type="button" aria-controls="tip-reading-in-the-files-for-rstudio-users-contents" aria-expanded="true" aria-label="Toggle tip box: Reading in the files for RStudio users"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden"></span> Tip: Reading in the files for RStudio users<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>If you are working in RStudio Cloud, you have to click on ‚ÄòUpload‚Äô button in the right bottom window toolbar and choose already downloaded data files to upload. You should now see all three files in this window. You might want to rename the files to make their names shorter.</p>

  <figure id="figure-2"><img src="../../images/scrna-casestudy-monocle/r_files_tab.png" alt="Screenshot of Files tab in RStudio, highlighting 'Upload' and 'Rename' buttons and listing three uploaded and renamed files: 'cell_metadata', 'gene_metadata', 'expression_matrix'." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 2:</span> The view of the Files tab with uploaded files and highlighted relevant buttons.</figcaption></figure>

  <p>If you are using RStudio <span class="notranslate">Galaxy</span> tool, you can get data directly from your history by running:</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># get the files from <span class="notranslate">Galaxy</span> history
file.copy(gx_get(2), "cell_metadata")
file.copy(gx_get(3), "gene_metadata")
file.copy(gx_get(4), "<span class="notranslate">expression</span>_matrix")
</code></pre></div>  </div>
  <p>The number in the brackets corresponds to the dataset number in your history, so make sure you put the right number for the corresponding file. We can specify the name of the fetched files in the quotation marks, as shown above. All three files should appear in the Files tab window.</p>

  <p>If you are using RStudio locally, then you don‚Äôt have to bother about uploading the files ‚Äì just run <code class="language-plaintext highlighter-rouge">file.choose()</code> and choose the corresponding file which you want to get path to:</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># get the file path
cells_path &lt;- file.choose() 
genes_path &lt;- file.choose() 
<span class="notranslate">expression</span>_path &lt;- file.choose() 
</code></pre></div>  </div>
  <p>You should now see the new variables in the Environment tab window.</p>

</blockquote>

<h2 id="view-and-modify-the-files">View and modify the files</h2>

<p>According to <a href="https://cole-trapnell-lab.github.io/monocle3/docs/starting/">Monocle3 documentation</a>, <code class="language-plaintext highlighter-rouge"><span class="notranslate">expression</span>_matrix</code> should have genes as rows and cells as columns. Let‚Äôs check if that‚Äôs the case here.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n"><span class="notranslate">expression</span>_matrix</span><span class="w">           </span><span class="c1"># preview the content of the file by calling its name</span><span class="w">
</span></code></pre></div></div>
<p>We can see that in our matrix rows are cells and genes are columns, so we have to transpose the matrix simply using function <code class="language-plaintext highlighter-rouge">t()</code>. But before doing so, we will change its type from dataframe to matrix - this is Monocle‚Äôs requirement to generate cell_data_set afterwards.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n"><span class="notranslate">expression</span>_matrix</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n"><span class="notranslate">expression</span>_matrix</span><span class="p">)</span><span class="w">   </span><span class="c1"># change the type to matrix</span><span class="w">
</span><span class="n"><span class="notranslate">expression</span>_matrix</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">t</span><span class="p">(</span><span class="n"><span class="notranslate">expression</span>_matrix</span><span class="p">)</span><span class="w">           </span><span class="c1"># transpose the matrix</span><span class="w">
</span></code></pre></div></div>
<p>Another condition we have to satisfy if that one of the columns of the <code class="language-plaintext highlighter-rouge">gene_metadata</code> should be named ‚Äúgene_short_name‚Äù, which represents the gene symbol for each gene. Some functions won‚Äôt work without that. Do we have such a column? Let‚Äôs check.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gene_metadata</span><span class="w">             </span><span class="c1"># preview the content of the file to check the name of the column containing gene symbols</span><span class="w">
</span></code></pre></div></div>

<p>The second column indeed contains gene symbols, but is called ‚ÄúSymbol‚Äù instead of ‚Äúgene_short_name‚Äù. That can be easily changed by a simple assignment, as long as we know the number of the column that we want to modify. In our case the gene symbols are stored in column 2. We can access the column names by <code class="language-plaintext highlighter-rouge">colnames()</code>.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">colnames</span><span class="p">(</span><span class="n">gene_metadata</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'gene_short_name'</span><span class="w">     </span><span class="c1"># change the column name</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">gene_metadata</span><span class="p">)</span><span class="w">                             </span><span class="c1"># see the changes</span><span class="w">
</span></code></pre></div></div>

<h2 id="generating-cds-object">Generating CDS object</h2>
<p>Now let‚Äôs store our files in one object ‚Äì the cell_data_set. This is the main class used by Monocle to hold <span class="notranslate">single cell</span> <span class="notranslate">expression</span> data. The class is derived from the Bioconductor SingleCellExperiment class. It‚Äôs similar to Python‚Äôs AnnData storing a data matrix together with annotations of observations and variables. There are three ways of creating CDS object in monocle:</p>
<ul>
  <li>Using <code class="language-plaintext highlighter-rouge">new_cell_data_set()</code> function with three data frames as arguments (not their paths!): <span class="notranslate">expression</span> matrix (can also be a sparseMatrix), cell metadata and gene metadata</li>
  <li>Using <code class="language-plaintext highlighter-rouge">load_cellranger_data()</code> function providing the path to the folder containing 10X Genomics Cell Ranger output files. This function takes an argument <code class="language-plaintext highlighter-rouge">umi_cutoff</code> that determines how many <span class="notranslate">reads</span> a cell must have to be included</li>
  <li>Using <code class="language-plaintext highlighter-rouge">load_mm_data()</code> function providing the paths to matrix file and two metadata files (features and cell information).</li>
</ul>

<p>In this tutorial we will use the first option:</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create CDS object</span><span class="w">
</span><span class="n">cds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">new_cell_data_set</span><span class="p">(</span><span class="n"><span class="notranslate">expression</span>_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">cell_metadata</span><span class="p">,</span><span class="w"> </span><span class="n">gene_metadata</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>We are now ready to process our data!</p>

<blockquote class="details">
  <div class="box-title details-title" id="details-format-conversion"><button class="gtn-boxify-button details" type="button" aria-controls="details-format-conversion-contents" aria-expanded="true" aria-label="Toggle details box: Format conversion"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden"></span> Details: Format conversion<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Since Monocle‚Äôs CDS object is analogous to Python‚Äôs AnnData, why don‚Äôt we use some kind of conversion between those two formats? There is indeed a package called <code class="language-plaintext highlighter-rouge">sceasy</code> that helps easy conversion of different <span class="notranslate">single-cell</span> data formats to each other. However, when we tested this conversion on our dataset and then used Monocle to plot the <span class="notranslate">expression</span> of genes, the plots were not correct ‚Äì the <span class="notranslate">expression</span> was shown to be ideantical throughout the sample. For comparison, Seurat did well when plotting gene <span class="notranslate">expression</span> of the same converted object! Although conversion functions are very handy, you have to be aware that their output might be interpreted differently by certain packages. Therefore, to make sure that the analysis is reliable, we decided to generate CDS object directly using Monocle‚Äôs function.</p>
  <figure id="figure-3"><img src="../../images/scrna-casestudy-monocle/monocle_seurat.png" alt="Comparison between plots of gene expression generated by Monocle and Seurat using the CDS object that was converted from AnnData using SCEasy tool. Gene expression in Monocle plots is identical throughout the sample, while the expression of the same genes plotted by Seurat is noticeable only in specific clusters." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 3:</span> Comparison between plots of gene <span class="notranslate">expression</span> generated by Monocle and Seurat using the CDS object that was converted from AnnData using SCEasy tool.</figcaption></figure>

</blockquote>

<h1 id="additional-step-adding-genes-symbols-based-on-their-ids">Additional step: adding genes symbols based on their IDs</h1>
<blockquote class="warning">
  <div class="box-title warning-title" id="warning-additional-step" aria-label="warning box: Additional step"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i><span class="visually-hidden"></span> Warning: Additional step</div>
  <p>This step is not necessary for the dataset we are working on but some users might find it helpful when analysing their own data.</p>

</blockquote>

<p>If you remember the very first tutorial, we were starting with gene IDs and adding gene symbols based on the Ensembl GTF file.<br />
But what if we didn‚Äôt have the genes symbols in our CDS object and wanted to add them now? Of course - it‚Äôs possible! We will also base this annotation on Ensembl - the genome database ‚Äì with the use of the library BioMart. We will use the same archive as in the Alevin tutorial (Genome assembly GRCm38) to get the gene names. Please note that the updated version (GRCm39) is available, but some of the gene IDs are not in that EnsEMBL database. The code below is written in a way that it will work for the updated dataset too, but will produce ‚ÄòNA‚Äô where the corresponding gene name couldn‚Äôt be found.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cds_extra</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cds</span><span class="w">                                        </span><span class="c1"># assign our CDS to a new object for the demonstration purpose</span><span class="w">
</span><span class="n">rownames</span><span class="p">(</span><span class="n">fData</span><span class="p">(</span><span class="n">cds_extra</span><span class="p">))</span><span class="w">                              </span><span class="c1"># preview of the gene IDs as rownames</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># get relevant gene names</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"biomaRt"</span><span class="p">)</span><span class="w">                                      </span><span class="c1"># load the BioMart library</span><span class="w">
</span><span class="n">ensembl.ids</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rownames</span><span class="p">(</span><span class="n">fData</span><span class="p">(</span><span class="n">cds_extra</span><span class="p">))</span><span class="w">               </span><span class="c1"># fData() allows to access cds rowData table</span><span class="w">
</span><span class="n">mart</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">useEnsembl</span><span class="p">(</span><span class="n">biomart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ENSEMBL_MART_ENSEMBL"</span><span class="p">)</span><span class="w">    </span><span class="c1"># connect to a specified BioMart database and dataset hosted by Ensembl</span><span class="w">
</span><span class="n">ensembl_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">useMart</span><span class="p">(</span><span class="s2">"ensembl"</span><span class="p">,</span><span class="w"> </span><span class="n">dataset</span><span class="o">=</span><span class="s2">"mmusculus_gene_ensembl"</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="o">=</span><span class="s1">'https://nov2020.archive.ensembl.org'</span><span class="p">)</span><span class="w"> 	

</span><span class="c1"># The line above connects to a specified BioMart database and dataset within this database.</span><span class="w">
</span><span class="c1"># In our case we choose the mus musculus database and to get the desired Genome assembly GRCm38, </span><span class="w">
</span><span class="c1"># we specify the host with this archive. If you want to use the most recent version of the dataset, just run:</span><span class="w">
</span><span class="c1"># ensembl_m = useMart("ensembl", dataset="mmusculus_gene_ensembl")</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">genes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">getBM</span><span class="p">(</span><span class="n">attributes</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'ensembl_gene_id'</span><span class="p">,</span><span class="s1">'exte<span class="notranslate">rna</span>l_gene_name'</span><span class="p">),</span><span class="w">
               </span><span class="n">filters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'ensembl_gene_id'</span><span class="p">,</span><span class="w"> 
               </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ensembl.ids</span><span class="p">,</span><span class="w"> 
               </span><span class="n">mart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ensembl_m</span><span class="p">)</span><span class="w">

</span><span class="c1"># The line above retrieves the specified attributes from the connected BioMart database; </span><span class="w">
</span><span class="c1"># 'ensembl_gene_id' are genes IDs, </span><span class="w">
</span><span class="c1"># 'exte<span class="notranslate">rna</span>l_gene_name' are the genes symbols that we want to get for our values stored in ‚Äòensembl.ids‚Äô.</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see the resulting data</span><span class="w">
</span><span class="n">genes</span><span class="w">                             
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># replace IDs for gene names </span><span class="w">
</span><span class="n">gene_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ensembl.ids</span><span class="w">	 
</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> 	 
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">geneID</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">gene_names</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="w">
 </span><span class="n">index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">genes</span><span class="o">==</span><span class="n">geneID</span><span class="p">)</span><span class="w">    </span><span class="c1"># finds an index of geneID in the genes object created by getBM()</span><span class="w">
 </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">==</span><span class="m">0</span><span class="p">)</span><span class="w">            </span><span class="c1"># condition in case if there is no corresponding gene name in the chosen dataset</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="n">gene_names</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'NA'</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="k">else</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="n">gene_names</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">genes</span><span class="o">$</span><span class="n">exte<span class="notranslate">rna</span>l_gene_name</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> 	</span><span class="c1"># replaces gene ID by the corresponding gene name based on the found geneID‚Äôs index </span><span class="w">
  </span><span class="p">}</span><span class="w">
 </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">                </span><span class="c1"># increased count so that every element in gene_names is replaced</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># store the gene names in our CDS object in a new column gene_short_name_extra</span><span class="w">
</span><span class="n">fData</span><span class="p">(</span><span class="n">cds_extra</span><span class="p">)</span><span class="o">$</span><span class="n">gene_short_name_extra</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gene_names</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see the changes</span><span class="w">
</span><span class="n">fData</span><span class="p">(</span><span class="n">cds_extra</span><span class="p">)</span><span class="w">                    
</span></code></pre></div></div>

<p>If you are working on your own data and it‚Äôs not mouse data, you can check available datasets for other species and just use relevant dataset in <code class="language-plaintext highlighter-rouge">useMart()</code> function.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">listDatasets</span><span class="p">(</span><span class="n">mart</span><span class="p">)</span><span class="w">                </span><span class="c1"># available datasets</span><span class="w">
</span></code></pre></div></div>

<blockquote class="warning">
  <div class="box-title warning-title" id="warning-ensembl-connection-problems" aria-label="warning box: Ensembl connection problems"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i><span class="visually-hidden"></span> Warning: Ensembl connection problems</div>
  <p>Sometimes you may encounter some connection issues with Ensembl. To improve performance Ensembl provides several mirrors of their site distributed around the globe. When you use the default settings for useEnsembl() your queries will be directed to your closest mirror geographically. In theory this should give you the best performance, however this is not always the case in practice. For example, if the nearest mirror is experiencing many queries from other users it may perform poorly for you. In such cases, the other mirrors should be chosen automatically.</p>

</blockquote>

<h1 id="monocle-workflow">Monocle <span class="notranslate">workflow</span></h1>
<p>Do you remember the Monocle <span class="notranslate">workflow</span> introduced in the previous tutorial? Here is a recap:</p>
<figure id="figure-4"><img src="../../images/scrna-casestudy-monocle/monocle3_new_workflow.png" alt="Monocle workflow: scRNA-seq dataset, pre-process data (normalise, remove batch effects), non-linear dimensionality reduction (t-SNE, UMAP), cluster cells, compare clusters (identify top markers, targeted contrasts), trajectory analysis. " loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 4:</span> <span class="notranslate">Workflow</span> provided by Monocle3 documentation</figcaption></figure>

<h2 id="pre-processing">Pre-processing</h2>
<p>Let‚Äôs start with normalisation and pre-processing that can be performed using the function <code class="language-plaintext highlighter-rouge">preprocess_cds()</code>. The argument <code class="language-plaintext highlighter-rouge">num_dim</code> is the number of principal components that will be computed when using PCA during normalisation. Then you can check that you‚Äôre using enough PCs to capture most of the variation in gene <span class="notranslate">expression</span> across all the cells in the data set. Note that ‚ÄúPCA‚Äù is the default method of pre-processing in Monocle3, so although we can specify this in our function, we don‚Äôt have to.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># PCA pre-processing with 210 principal components</span><span class="w">
</span><span class="n">cds_preprocessing</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">preprocess_cds</span><span class="p">(</span><span class="n">cds</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"PCA"</span><span class="p">,</span><span class="w"> </span><span class="n">num_dim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">210</span><span class="p">)</span><span class="w"> 
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="c1"># plot the variation in gene <span class="notranslate">expression</span> vs PCA components</span><span class="w">
</span><span class="n">plot_pc_variance_explained</span><span class="p">(</span><span class="n">cds_preprocessing</span><span class="p">)</span><span class="w">                              		                            
</span></code></pre></div></div>

<figure id="figure-5"><img src="../../images/scrna-casestudy-monocle/pca_plot.jpg" alt="Plot of variation in gene expression vs PCA components, decreasing exponentially." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 5:</span>  Plot of variation in gene <span class="notranslate">expression</span> vs PCA components.</figcaption></figure>

<p>The plot shows that actually using more than ~100 PCs captures only a small amount of additional variation. However, if we look at how the cells are plotted on 2D graph when using different values of PCs, it is easier to imagine how the <code class="language-plaintext highlighter-rouge">num_dim</code> actually affects the output. Therefore, for this demonstration we will use the value of 210, which, compared to the results from the previous tutorial, makes the most sense for our dataset. However, it will take quite some time to run this, and this is why generally smaller PCs are preferable, so feel free to use <code class="language-plaintext highlighter-rouge">num_dim</code> value around 100 to accelerate preprocessing and compare the results.</p>

<figure id="figure-6"><img src="../../images/scrna-casestudy-monocle/num_dim.jpg" alt="Six plots showing only the shaded shape of how the cells are clustered depending on the num_dim argument. The general trend is maintained though." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 6:</span> The "shape" of the plot showing how the cells are clustered depending on the 'num_dim' argument.</figcaption></figure>

<h2 id="batch-correction-and-dimensionality-reduction">Batch correction and Dimensionality reduction</h2>
<p>Our dataset actually comprises data from 7 samples, so there is a risk that the batch effects can be observed. Those are systematic differences in the transcriptome of cells measured in different experimental batches. However, we can use Monocle to deal with that!
First, let‚Äôs check how our dataset looks like in terms of batch effects. We can do that by colouring the cells by batch.  This information is stored in our CDS object from <code class="language-plaintext highlighter-rouge">cell_metadata</code> file. Before asking Monocle to plot anything, let‚Äôs check the exact column name of the batch information column.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">colnames</span><span class="p">(</span><span class="n">colData</span><span class="p">(</span><span class="n">cds_preprocessing</span><span class="p">))</span><span class="w"> 	          </span><span class="c1"># check column names</span><span class="w">
</span></code></pre></div></div>
<p>In our case it‚Äôs indeed ‚Äòbatch‚Äô, but your data might have another name (eg. ‚Äúplate‚Äù, etc.), so make sure you put the correct argument value.</p>

<p>Then, we have to reduce dimension before attempting to plot. The <a href="/training-material/topics/single-cell/tutorials/scrna-case_monocle3-trajectories/tutorial.html">previous tutorial</a> introduced the methods of dimensionality reduction in Monocle. Of course you can replicate what we did in <span class="notranslate">Galaxy</span> to compare the output of dimensionality reduction using different methods, simply by changing the <code class="language-plaintext highlighter-rouge">reduction_method</code> argument. Options currently supported by Monocle are ‚ÄúUMAP‚Äù, ‚ÄútSNE‚Äù, ‚ÄúPCA‚Äù, ‚ÄúLSI‚Äù, and ‚ÄúAligned‚Äù. However, as for now, let‚Äôs just recall that UMAP gave the best results, so we will use UMAP here as well.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># reduce dimension first</span><span class="w">
</span><span class="n">cds_preprocessing_UMAP</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">reduce_dimension</span><span class="p">(</span><span class="n">cds_preprocessing</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">preprocess_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"PCA"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># then produce a plot to check for batch effects</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_preprocessing_UMAP</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="o">=</span><span class="s2">"batch"</span><span class="p">,</span><span class="w"> </span><span class="n">label_cell_groups</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>We can see that upper and lower right branches mostly consist of N705 and N706, so indeed batch correction might be helpful. Let‚Äôs run this.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># perform batch correction</span><span class="w">
</span><span class="n">cds_batch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">align_cds</span><span class="p">(</span><span class="n">cds_preprocessing_UMAP</span><span class="p">,</span><span class="w"> </span><span class="n">preprocess_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"PCA"</span><span class="p">,</span><span class="w"> </span><span class="n">alignment_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"batch"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>To see the changes, we have to run UMAP again, but this time on the aligned dataset, so we will specify that <code class="language-plaintext highlighter-rouge">preprocess_method </code> is now ‚ÄúAligned‚Äù and not ‚ÄúPCA‚Äù, however after having used <code class="language-plaintext highlighter-rouge">align_cds()</code> Monocle would use ‚ÄúAligned‚Äù argument automatically if no <code class="language-plaintext highlighter-rouge">preprocess_method</code> was specified.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># dimensionality reduction after alignment</span><span class="w">
</span><span class="n">cds_red_dim</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">reduce_dimension</span><span class="p">(</span><span class="n">cds_batch</span><span class="p">,</span><span class="w"> </span><span class="n">preprocess_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Aligned"</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">)</span><span class="w">  
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see the batch correction effect on a plot</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_red_dim</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="o">=</span><span class="s2">"batch"</span><span class="p">,</span><span class="w"> </span><span class="n">label_cell_groups</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">		
</span></code></pre></div></div>

<figure id="figure-7"><img src="../../images/scrna-casestudy-monocle/batch_correction.png" alt="Left image showing dataset before batch correction: upper and lower right branches mostly consist of N705 and N706. Right image showing the dataset after batch correction: the cells from all the samples are evenly spread throughout the whole dataset." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 7:</span> Comparison of the dataset before and after batch correction.</figcaption></figure>

<p>Do you see this? That‚Äôs amazing! Batch correction did a great job here! Now the dataset is nicely aligned, and the cells from all the samples are evenly spread throughout the whole dataset. It is worth mentioning that removing batch effects was done using <a href="https://doi.org/10.1038/nbt.4091">mutual nearest neighbor alignment</a>, a technique introduced by John Marioni‚Äôs lab (<span class="citation"><a href="#Haghverdi_2018">Haghverdi <i>et al.</i> 2018</a></span>) and supported by Aaron Lun‚Äôs package <a href="https://bioconductor.org/packages/release/bioc/html/batchelor.html">batchelor</a>. 
Now we can move to the next step and perform dimensionality reduction.</p>

<blockquote class="tip">
  <div class="box-title tip-title" id="tip-plotting-labels-vs-legend"><button class="gtn-boxify-button tip" type="button" aria-controls="tip-plotting-labels-vs-legend-contents" aria-expanded="true" aria-label="Toggle tip box: Plotting: labels vs legend"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden"></span> Tip: Plotting: labels vs legend<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>When creating graphs, we sometimes use labels and sometimes just a legend. You can choose whichever you think makes the data clear and readable.</p>

  <p>If you want to use a legend, then specify an argument <code class="language-plaintext highlighter-rouge">label_cell_groups=FALSE</code> in the function <code class="language-plaintext highlighter-rouge">plot_cells()</code>.</p>

  <p>The labels are set automatically, but if you want to change their size (default labels are tiny), use the argument <code class="language-plaintext highlighter-rouge">group_label_size</code>.</p>
</blockquote>

<h2 id="clustering-clusters">Clustering: clusters</h2>
<p>We want to get some information about cell types, don‚Äôt we? In order to do so, we have to cluster our cells first. 
Monocle uses a technique called ‚Äúcommunity detection‚Äù (<span class="citation"><a href="#Traag_2019">Traag <i>et al.</i> 2019</a></span>) to group cells. This approach was introduced by <span class="citation"><a href="#Levine_2015">Levine <i>et al.</i> 2015</a></span> as part of the phenoGraph algorithm.
Monocle also divides the cells into larger, more well separated groups called partitions, using a statistical test from <span class="citation"><a href="#Wolf_2019">Wolf <i>et al.</i> 2019</a></span>, introduced as part of their <a href="https://github.com/theislab/paga">PAGA</a> algorithm.</p>

<blockquote class="details">
  <div class="box-title details-title" id="details-clusters-vs-partitions"><button class="gtn-boxify-button details" type="button" aria-controls="details-clusters-vs-partitions-contents" aria-expanded="true" aria-label="Toggle details box: Clusters vs partitions"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden"></span> Details: Clusters vs partitions<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Clusters are particularly useful while trying to assign cells to a certain type, because they are based on the similarity in gene <span class="notranslate">expression</span>. The relationships between different clusters are analysed to identify possible trajectories.</p>

  <p>Partitions, meanwhile, are larger groups of cells that usually contain several clusters. Trajectory inference is performed only within one partition, so it is essential that all the cells that we want to analyse in pseudotime belong to the same partition.</p>

</blockquote>

<p>Therefore, let‚Äôs perform clustering and visualise the resulting clusters.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># clustering </span><span class="w">
</span><span class="n">cds_auto_cluster</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cluster_cells</span><span class="p">(</span><span class="n">cds_red_dim</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">)</span><span class="w"> 
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see the clusters</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_auto_cluster</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'cluster'</span><span class="p">,</span><span class="w"> </span><span class="n">group_label_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w">     
</span></code></pre></div></div>

<p>When using standard igraph louvain clustering, the value of resolution parameter is by default set to NULL, which means that it is determined automatically. Although the resulting clusters are OK, it would be nice to get some more granularity to identify cell types more specifically. The higher the resolution value, the more clusters we get. We will set the resolution value to 0.0002, but you are very welcome to try different values to see the changes.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># clustering with changed resolution value</span><span class="w">
</span><span class="n">cds_clustered</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cluster_cells</span><span class="p">(</span><span class="n">cds_red_dim</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.0002</span><span class="p">)</span><span class="w"> 
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see the new clusters</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_clustered</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'cluster'</span><span class="p">,</span><span class="w"> </span><span class="n">group_label_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w"> 	
</span></code></pre></div></div>

<figure id="figure-8"><img src="../../images/scrna-casestudy-monocle/clusters_compare.png" alt="Left image showing 6 clusters formed using automatic standard igraph louvain clustering. Right image showing the dataset with clusters formed using resolution argument set to 0.0002: now there are 7 clusters, as one automatically formed cluster could be divided into two smaller distinct clusters." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 8:</span> Comparison of the clusters formed using standard igraph louvain clustering and using resolution argument set to 0.0002.</figcaption></figure>

<h2 id="clustering-partitions">Clustering: partitions</h2>
<p>OK, what about partitions? They were also created during the clustering step and it‚Äôs important to check them before learning the trajectory because it is performed only within one partition, so it is essential that all the cells that we want to analyse in pseudotime belong to the same partition.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see the partitions</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_clustered</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'partition'</span><span class="p">,</span><span class="w"> </span><span class="n">label_cell_groups</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">	
</span></code></pre></div></div>

<p>We can see that there are 3 partitions identified in <code class="language-plaintext highlighter-rouge">cds_clustered</code> object. Ideally, we would like to combine partitions 1 and 2 to draw a trajectory through all those cells (we can ignore cells in partition 3). Sometimes using the default values might result in multiple partitions while you only need one. Then you would have to change the q-value cutoff in <code class="language-plaintext highlighter-rouge">partition_qval</code>. The default is 0.05 and by increasing this value you can increase the span of partitions, meaning that you would get fewer partitions. When trying different values of q-value, you also have to check if the clusters didn‚Äôt change. It‚Äôs all about finding a balance between the value of <code class="language-plaintext highlighter-rouge">resolution</code> and <code class="language-plaintext highlighter-rouge">partition_qval</code> so that both clusters and partitions are satisfactory enough for <span class="notranslate">downstream</span> analysis. Let‚Äôs try that on our dataset.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># changing the partition q-value</span><span class="w">
</span><span class="n">cds_clustered</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cluster_cells</span><span class="p">(</span><span class="n">cds_red_dim</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.0002</span><span class="p">,</span><span class="w"> </span><span class="n">partition_qval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> 
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see the partitions with the changed q-value</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_clustered</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'partition'</span><span class="p">,</span><span class="w"> </span><span class="n">label_cell_groups</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># check if clusters didn't change</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_clustered</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'cluster'</span><span class="p">,</span><span class="w"> </span><span class="n">label_cell_groups</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">	
</span></code></pre></div></div>
<p>Voila - it worked as expected! Now we have cells from partition 1 and 2 in one partition, we still have 7 clusters, so we can learn the trajectory. However, in some cases even this method might not be enough. Then, there is a last resort‚Ä¶ assigning cells to a partition manually.</p>

<h2 id="additional-step-assigning-cells-to-one-partition">Additional step: assigning cells to one partition</h2>
<blockquote class="warning">
  <div class="box-title warning-title" id="warning-additional-step-1" aria-label="warning box: Additional step"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i><span class="visually-hidden"></span> Warning: Additional step</div>
  <p>This step is not necessary for the dataset we are working on but some users might find it helpful when analysing their own data.</p>

</blockquote>

<p>Let‚Äôs assume we have 4 partitions that cannot be extended to one big partition using <code class="language-plaintext highlighter-rouge">partition_qval</code> (it might sound unreasonable but it does happen!) and we are desperate to have all the cells in one partition to draw a trajectory through all of them. We can simulate the initial dataset by setting <code class="language-plaintext highlighter-rouge">partition_qval</code> value to 0.0001.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># simulate the dataset</span><span class="w">
</span><span class="n">cds_partitions_extra</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cluster_cells</span><span class="p">(</span><span class="n">cds_red_dim</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">partition_qval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.0001</span><span class="p">)</span><span class="w">		
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see the simulated partitions</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_partitions_extra</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'partition'</span><span class="p">,</span><span class="w"> </span><span class="n">label_cell_groups</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># store ‚Äò1‚Äô the number of times equal to the number of cells</span><span class="w">
</span><span class="n">big_partition</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nf">length</span><span class="p">(</span><span class="n">cds_partitions_extra</span><span class="o">@</span><span class="n">colData</span><span class="o">@</span><span class="n">rownames</span><span class="p">)))</span><span class="w"> 	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># take the barcode of each cell and assign ‚Äò1‚Äô to each of them (now the ‚Äòones‚Äô are named) </span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">big_partition</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cds_partitions_extra</span><span class="o">@</span><span class="n">colData</span><span class="o">@</span><span class="n">rownames</span><span class="w"> 	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># convert from numeric to factor</span><span class="w">
</span><span class="n">big_partition</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">big_partition</span><span class="p">)</span><span class="w">	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># assign the created barcodes-partition list to the location where information about partitions is stored in CDS object</span><span class="w">
</span><span class="n">cds_partitions_extra</span><span class="o">@</span><span class="n">clusters</span><span class="o">$</span><span class="n">UMAP</span><span class="o">$</span><span class="n">partitions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">big_partition</span><span class="w"> 	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see the new partition assignment</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_partitions_extra</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'partition'</span><span class="p">,</span><span class="w"> </span><span class="n">label_cell_groups</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">	
</span></code></pre></div></div>

<figure id="figure-9"><img src="../../images/scrna-casestudy-monocle/partitions_compare.png" alt="Left image showing the dataset divided into 4 partitions. Right image showing all cells assigned to one partition." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 9:</span> The result of the manual assignment of all the cells to one partition.</figcaption></figure>

<blockquote class="details">
  <div class="box-title details-title" id="details-and-operators"><button class="gtn-boxify-button details" type="button" aria-controls="details-and-operators-contents" aria-expanded="true" aria-label="Toggle details box: @ and $ operators"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden"></span> Details: @ and $ operators<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>As you saw above, we used <code class="language-plaintext highlighter-rouge">@</code> and <code class="language-plaintext highlighter-rouge">$</code> operators to navigate in CDS object. What is the difference between them? <code class="language-plaintext highlighter-rouge">$</code> operator is used to access one variable/column, while <code class="language-plaintext highlighter-rouge">@</code> extracts the contents of a slot in an object with a formal (S4) class structure. If you use <code class="language-plaintext highlighter-rouge">View()</code> function on our CDS object, you will see the elements of type ‚ÄúS4‚Äù that you can access using <code class="language-plaintext highlighter-rouge">@</code> operator. The suggestion list of elements that can be accessed should also pop up as you type the name of the object followed by the corresponding operator.</p>

</blockquote>

<h1 id="assigning-cell-types">Assigning cell types</h1>
<p>There are two main approaches to assigning cell types to clusters that we‚Äôve just identified ‚Äì supervised and unsupervised, both based on gene <span class="notranslate">expression</span> in each cluster.</p>

<h2 id="supervised-approach">Supervised approach</h2>
<p>Supervised approach relies on the fact that when having a reference, we know which cell types to expect and we can simply check the <span class="notranslate">expression</span> of marker genes specific to the expected cell types. Let‚Äôs then check the markers mentioned in the original paper <span class="citation"><a href="#Bacon2018">Bacon <i>et al.</i> 2018</a></span>.</p>

<table>
  <thead>
    <tr>
      <th>Marker</th>
      <th>Cell type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Il2ra</td>
      <td>Double negative (early T-cell)</td>
    </tr>
    <tr>
      <td>Cd8b1, Cd8a, Cd4</td>
      <td>Double positive (middle T-cell)</td>
    </tr>
    <tr>
      <td>Cd8b1, Cd8a, Cd4 - high</td>
      <td>Double positive (late middle T-cell)</td>
    </tr>
    <tr>
      <td>Itm2a</td>
      <td>Mature T-cell</td>
    </tr>
    <tr>
      <td>Aif1</td>
      <td>Macrophages</td>
    </tr>
    <tr>
      <td>Hba-a1</td>
      <td>RBC</td>
    </tr>
  </tbody>
</table>

<p>To plot the <span class="notranslate">expression</span> of all those genes across our dataset in one go, we will pass a vector with the names of those markers into a parameter <code class="language-plaintext highlighter-rouge">genes</code> in the <code class="language-plaintext highlighter-rouge">plot_cells</code> function.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># <span class="notranslate">expression</span> of marker genes across the sample</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_clustered</span><span class="p">,</span><span class="w"> </span><span class="n">genes</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'Il2ra'</span><span class="p">,</span><span class="s1">'Cd8b1'</span><span class="p">,</span><span class="s1">'Cd8a'</span><span class="p">,</span><span class="s1">'Cd4'</span><span class="p">,</span><span class="s1">'Itm2a'</span><span class="p">,</span><span class="s1">'Aif1'</span><span class="p">,</span><span class="s1">'Hba-a1'</span><span class="p">),</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<figure id="figure-10"><img src="../../images/scrna-casestudy-monocle/genes.png" alt="7 graphs, each showing expression of one of the genes in the corresponding clusters: 'Il2ra' ‚Äì cluster 4; 'Cd8b1' and 'Cd8a' ‚Äì clusters 1,6,2; 'Cd4' ‚Äì high expression in cluster 5; 'Itm2a' ‚Äì cluster 3; 'Aif1' ‚Äì barely anything, no specific cluster assigned; 'Hba-a1' - throughout the entire sample in low numbers." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 10:</span> <span class="notranslate">Expression</span> of the reference marker genes across analysed sample.</figcaption></figure>

<blockquote class="question">
  <div class="box-title question-title" id="question-genes-cell-types-and-clusters" aria-label="question box: Genes, cell types and clusters"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden"></span> Question: Genes, cell types and clusters</div>
  <p>Based on the gene <span class="notranslate">expression</span> graph that we just generated, the table above and your knowledge from the previous tutorials, how would you assign the clusters?</p>

  <blockquote class="solution">
    <div class="box-title solution-title" id="solution-2"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-2-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">Il2ra</code> (DN): mostly expressed in cluster 4</li>
      <li><code class="language-plaintext highlighter-rouge">Cd8b1, Cd8a</code> (DP middle): expressed in clusters 1, 6, and highly in cluster 2</li>
      <li><code class="language-plaintext highlighter-rouge">Cd4</code> (DP late): average <span class="notranslate">expression</span> in clusters 1, 6, 2 and high <span class="notranslate">expression</span> in cluster 5</li>
      <li><code class="language-plaintext highlighter-rouge">Itm2a</code> (T-mat): expressed in cluster 3</li>
      <li><code class="language-plaintext highlighter-rouge">Aif1</code> (macrophages): barely anything here, minimal <span class="notranslate">expression</span> spread across the sample with some more cells in cluster 4 and 3 ‚Äì not enough to form a distinct cluster though). In theory, we shouldn‚Äôt have any macrophages in our sample. If you remember from the previous tutorials, we actually filtered out macrophages from the sample during the processing step, because we worked on annotated data. When analysing unannotated data, we could only assign macrophages and then filter them out, provided that Monocle clusters them into a separate group. As you can see, it‚Äôs not the case here, so we will just carry on with the analysis, interpreting this as a contamination.</li>
      <li><code class="language-plaintext highlighter-rouge">Hba-a1</code> (RBC): appears throughout the entire sample in low numbers suggesting some background contamination of red blood cell debris in the cell samples during library generation, but also shows higher <span class="notranslate">expression</span> in a distinct tiny bit of cluster 3, at the border between clusters 1 and 5. However, it‚Äôs too small to be clustered into a separate group and filtered out in this case. 
If you remember, this gene was found to be expressed in the previous Scanpy tutorial also in low numbers across the sample, and in the other Monocle tutorial (using <span class="notranslate">Galaxy</span> tools and annotated data) algorithms allowed us to gather the cells expressing that gene into a distinct group. Our result now sits somewhere in between.</li>
    </ul>
    <figure id="figure-11"><img src="../../images/scrna-casestudy-monocle/hb_all.png" alt="In Scanpy graph the marker gene appears throughout the entire sample in low numbers, in Monocle in Galaxy cells expressing hemoglobin gene were grouped into a small branch of DP-M4, allowing to group those cells. Monocle in RStudio graph is somewhere in between showing mostly low expression across the sample, but also having a tiny bit of grouped cells, less distinct than in Galaxy though." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 11:</span> Hemoglobin across clusters - comparison between Scanpy, Monocle using <span class="notranslate">Galaxy</span> tools and Monocle run in RStudio.</figcaption></figure>

  </blockquote>
</blockquote>

<p>Having identified which cluster corresponds to a specific cell type, we can finally run some code to add the annotation to our CDS object. First, we will create a new column called <code class="language-plaintext highlighter-rouge">cell_type</code>  in <code class="language-plaintext highlighter-rouge">colData()</code> - this is where the information about the cells is stored (eg. batch, genotype, sex, etc) - and initialize it with the values of clusters. Then, we will get the <code class="language-plaintext highlighter-rouge">dplyr</code> package which will be used for clusters annotation.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># just to keep the objects tidy and not overwrite them so that you can come back to any point of the analysis </span><span class="w">
</span><span class="n">cds_annotated</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cds_clustered</span><span class="w"> 	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create a new column ‚Äòcell_type‚Äô and initialise it with clusters values</span><span class="w">
</span><span class="n">colData</span><span class="p">(</span><span class="n">cds_annotated</span><span class="p">)</span><span class="o">$</span><span class="n">cell_type</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">clusters</span><span class="p">(</span><span class="n">cds_annotated</span><span class="p">))</span><span class="w"> 	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># annotate clusters</span><span class="w">
</span><span class="n">colData</span><span class="p">(</span><span class="n">cds_annotated</span><span class="p">)</span><span class="o">$</span><span class="n">cell_type</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="n">recode</span><span class="p">(</span><span class="n">colData</span><span class="p">(</span><span class="n">cds_annotated</span><span class="p">)</span><span class="o">$</span><span class="n">cell_type</span><span class="p">,</span><span class="w">
                                                       </span><span class="s1">'1'</span><span class="o">=</span><span class="s1">'DP-M1'</span><span class="p">,</span><span class="w">   </span><span class="c1"># double positive ‚Äì middle T-cell (1st cluster)</span><span class="w">
                                                       </span><span class="s1">'2'</span><span class="o">=</span><span class="s1">'DP-M2'</span><span class="p">,</span><span class="w">	  </span><span class="c1"># double positive ‚Äì middle T-cell (2nd cluster)</span><span class="w">
                                                       </span><span class="s1">'3'</span><span class="o">=</span><span class="s1">'T-mat'</span><span class="p">,</span><span class="w">	  </span><span class="c1"># mature T-cell</span><span class="w">
                                                       </span><span class="s1">'4'</span><span class="o">=</span><span class="s1">'DN'</span><span class="p">,</span><span class="w">		  </span><span class="c1"># double negative ‚Äì early T-cell</span><span class="w">
                                                       </span><span class="s1">'5'</span><span class="o">=</span><span class="s1">'DP-L'</span><span class="p">,</span><span class="w">	  </span><span class="c1"># double positive ‚Äì late middle T-cell</span><span class="w">
                                                       </span><span class="s1">'6'</span><span class="o">=</span><span class="s1">'DP-M3'</span><span class="p">,</span><span class="w">	  </span><span class="c1"># double positive ‚Äì middle T-cell (3rd cluster)</span><span class="w">
                                                       </span><span class="s1">'7'</span><span class="o">=</span><span class="s1">'Unknown'</span><span class="p">)</span><span class="w"> </span><span class="c1"># no info for now, so call it ‚ÄòUnknown‚Äô</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># check the annotation </span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_annotated</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="o">=</span><span class="s2">"cell_type"</span><span class="p">,</span><span class="w"> </span><span class="n">label_cell_groups</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">    
</span></code></pre></div></div>

<figure id="figure-12"><img src="../../images/scrna-casestudy-monocle/annotated.png" alt="A plot showing the identified clusters, now each coloured by the assigned cell type." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 12:</span> Our annotated dataset.</figcaption></figure>

<h2 id="unsupervised-approach">Unsupervised approach</h2>
<p>But what if we don‚Äôt have any reference that we can use to assign our clusters? In that case, we will turn to the mentioned unsupervised approach - we will check what are the specifically expressed genes for each cluster. Then we can identify the cell types by looking up what cell types the found genes are markers for. That‚Äôs a more tedious process, but sometimes can lead to exciting and unexpected results. 
We will use Monocle‚Äôs function <code class="language-plaintext highlighter-rouge">top_markers()</code> and store the information about specifically expressed genes for each cluster in the data frame <code class="language-plaintext highlighter-rouge">marker_test</code>.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># find top marker genes in each cluster</span><span class="w">
</span><span class="n">marker_test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">top_markers</span><span class="p">(</span><span class="n">cds_clustered</span><span class="p">,</span><span class="w"> </span><span class="n">group_cells_by</span><span class="o">=</span><span class="s2">"cluster"</span><span class="p">,</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">,</span><span class="w"> </span><span class="n">reference_cells</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span><span class="w"> </span><span class="n">cores</span><span class="o">=</span><span class="m">8</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>You can group the cells by any categorical variable in <code class="language-plaintext highlighter-rouge">colData(cds_clustered)</code>. The parameter <code class="language-plaintext highlighter-rouge">reference_cells</code> is used to accelerate the marker significance test at some cost in sensitivity. It works by randomly selecting a specified number of cells and performing the marker significance test against a chosen set of cells. If your dataset is not massively big, you might skip this parameter as it wouldn‚Äôt help much.</p>

<blockquote class="question">
  <div class="box-title question-title" id="question-2" aria-label="question box: "><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden"></span> Question</div>

  <p>What are the variables stored in <code class="language-plaintext highlighter-rouge">marker_test</code> data frame and what do they mean?</p>

  <blockquote class="solution">
    <div class="box-title solution-title" id="solution-3"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-3-contents" aria-expanded="true" aria-label="Toggle solution box: "><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden"></span> Solution<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

    <p>Those are 10 variables that you can check easily either using colnames(marker_test) or <code class="language-plaintext highlighter-rouge">View(marker_test)</code> which will also display all the corresponding values.</p>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">gene_id</code> - Ensembl gene ID</li>
      <li><code class="language-plaintext highlighter-rouge">gene_short_name</code> - short name of the gene corresponding to its ID</li>
      <li><code class="language-plaintext highlighter-rouge">cell_group</code> - a group to which the cell belongs, specified in the <code class="language-plaintext highlighter-rouge">group_cells_by</code> argument</li>
      <li><code class="language-plaintext highlighter-rouge">marker_score</code> - numeric vector of marker scores as the fraction expressing scaled by the specificity. The value ranges from 0 to 1</li>
      <li><code class="language-plaintext highlighter-rouge">mean_<span class="notranslate">expression</span></code> -  numeric vector of mean normalized <span class="notranslate">expression</span> of the gene in the cell group</li>
      <li><code class="language-plaintext highlighter-rouge">fraction_expressing</code> - numeric vector of fraction of cells expressing the gene within the cell group</li>
      <li><code class="language-plaintext highlighter-rouge">specificity</code> - numeric vector of a measure of how specific the gene‚Äôs <span class="notranslate">expression</span> is to the cell group based on the Jensen-Shannon divergence. The value ranges from 0 to 1.</li>
      <li><code class="language-plaintext highlighter-rouge">pseudo_R2</code> - numeric vector of pseudo R-squared values, a measure of how well the gene <span class="notranslate">expression</span> model fits the categorical data relative to the null model. The value ranges from 0 to 1.</li>
      <li><code class="language-plaintext highlighter-rouge">marker_test_p_value</code> - numeric vector of likelihood ratio p-values; p-value is an area in the tail of a distribution that tells you the odds of a result happening by chance</li>
      <li><code class="language-plaintext highlighter-rouge">marker_test_q_value</code> -  numeric vector of likelihood ratio q-values; q-value is a p-value that has been adjusted for the False Discovery Rate (FDR)</li>
    </ul>

  </blockquote>

</blockquote>

<p>We can now use data in <code class="language-plaintext highlighter-rouge">marker_test</code> to rank the cells based on one of the specificity metrics and take the top gene(s) for each cluster. We will filter the expressing cells that constitute more than 10% of the cell group and we will take 2 genes in each cluster with the highest <code class="language-plaintext highlighter-rouge">pseudo_R2</code> value (you can of course modify this value and choose more genes to be selected).</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># filter the ‚Äòmarker_test‚Äô data frame</span><span class="w">
</span><span class="n">top_specific_markers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">marker_test</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
                            </span><span class="n">dplyr</span><span class="o">::</span><span class="n">filter</span><span class="p">(</span><span class="n">fraction_expressing</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0.10</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
                            </span><span class="n">dplyr</span><span class="o">::</span><span class="n">group_by</span><span class="p">(</span><span class="n">cell_group</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
                            </span><span class="n">dplyr</span><span class="o">::</span><span class="n">top_n</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">pseudo_R2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># store the names of the marker genes</span><span class="w">
</span><span class="c1"># you can also use IDs, the conversion to gene names should happen automatically when plotting</span><span class="w">
</span><span class="n">top_marker_names</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">top_specific_markers</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="n">pull</span><span class="p">(</span><span class="n">gene_short_name</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Now we have all elements to plot the <span class="notranslate">expression</span> and fraction of cells that express found markers in each group.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot_genes_by_group</span><span class="p">(</span><span class="n">cds_clustered</span><span class="p">,</span><span class="w">                    </span><span class="c1"># our CDS object</span><span class="w">
                    </span><span class="n">top_marker_names</span><span class="p">,</span><span class="w">                 </span><span class="c1"># a list of gene names to show in the plot</span><span class="w">
                    </span><span class="n">group_cells_by</span><span class="o">=</span><span class="s2">"cluster"</span><span class="p">,</span><span class="w">         </span><span class="c1"># how to group cells when labeling </span><span class="w">
                    </span><span class="n">ordering_type</span><span class="o">=</span><span class="s2">"maximal_on_diag"</span><span class="p">)</span><span class="w">  </span><span class="c1"># how to order the genes / groups on the dot plot</span><span class="w">
</span></code></pre></div></div>

<figure id="figure-13"><img src="../../images/scrna-casestudy-monocle/gene_group.png" alt="A dot plot showing the expression of genes and fraction of cells that express found markers in each group. On the diagonal there are two genes corresponding to each cluster with the highest pseudo_R2 score in their group." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 13:</span> A plot of the <span class="notranslate">expression</span> and fraction of cells that express found markers in each group.</figcaption></figure>

<p>Look at this ‚Äì we have identified some more marker genes specific to each cluster! However, sometimes it happens that the found genes are not as specific as one would expect, and they appear across the whole sample. Therefore, it is a good idea to plot all those marker genes and check how they appear in the bigger picture.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot all the identified genes to check their <span class="notranslate">expression</span></span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_clustered</span><span class="p">,</span><span class="w"> </span><span class="n">genes</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'Pcdhgc4'</span><span class="p">,</span><span class="s1">'Pcdhga5'</span><span class="p">,</span><span class="s1">'Gm5559'</span><span class="p">,</span><span class="s1">'Gm10359'</span><span class="p">,</span><span class="s1">'Ccr9'</span><span class="p">,</span><span class="s1">'Cd8b1'</span><span class="p">,</span><span class="s1">'Plac8'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Il2ra'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Cd52'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Tmsb10'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Mki67'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Hmgb2'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Pclaf'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Npm1'</span><span class="p">),</span><span class="w"> </span><span class="n">reduction_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"UMAP"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<figure id="figure-14"><img src="../../images/scrna-casestudy-monocle/markers_plot.png" alt="Plots showing the expression of fourteen found marker genes across the whole sample. Those genes are 'Pcdhgc4','Pcdhga5','Gm5559','Gm10359','Ccr9','Cd8b1','Plac8', 'Il2ra', 'Cd52', 'Tmsb10', 'Mki67', 'Hmgb2', 'Pclaf', 'Npm1'." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 14:</span> Plots of the <span class="notranslate">expression</span> of marker genes across the sample.</figcaption></figure>

<p>Further steps from now would include reviewing literature and checking what cell types correspond to the genes expressed in each cluster. Then you can annotate your clusters in the same way as shown above. Once you have your clusters annotated, Monocle can generate a file of marker genes for the identified cell types. This file can be then used with <a href="https://cole-trapnell-lab.github.io/garnett/">Garnett</a>, a software toolkit for automatically annotating cells. We will not go through this in the current tutorial, but we will generate the file of marker genes.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># use ‚Äòtop_markers()‚Äô again, now grouping cells by the assigned cell type</span><span class="w">
</span><span class="n">assigned_marker_test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">top_markers</span><span class="p">(</span><span class="n">cds_annotated</span><span class="p">,</span><span class="w">
                                             </span><span class="n">group_cells_by</span><span class="o">=</span><span class="s2">"cell_type"</span><span class="p">,</span><span class="w">
                                             </span><span class="n">reference_cells</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span><span class="w">
                                             </span><span class="n">cores</span><span class="o">=</span><span class="m">8</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># filter these markers according to how stringent you want to be</span><span class="w">
</span><span class="n">garnett_markers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">assigned_marker_test</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
                        </span><span class="n">dplyr</span><span class="o">::</span><span class="n">filter</span><span class="p">(</span><span class="n">marker_test_q_value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">specificity</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0.25</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
                        </span><span class="n">dplyr</span><span class="o">::</span><span class="n">group_by</span><span class="p">(</span><span class="n">cell_group</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
                        </span><span class="n">dplyr</span><span class="o">::</span><span class="n">top_n</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">marker_score</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># exclude genes that are good markers for more than one cell type:</span><span class="w">
</span><span class="n">garnett_markers_filtered</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">garnett_markers</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
                        </span><span class="n">dplyr</span><span class="o">::</span><span class="n">group_by</span><span class="p">(</span><span class="n">gene_short_name</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
                        </span><span class="n">dplyr</span><span class="o">::</span><span class="n">filter</span><span class="p">(</span><span class="n">dplyr</span><span class="o">::</span><span class="n">n</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># generate a file of marker genes</span><span class="w">
</span><span class="n">generate_garnett_marker_file</span><span class="p">(</span><span class="n">garnett_markers_filtered</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="o">=</span><span class="s2">"./marker_file.txt"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>A new file should appear in the ‚ÄòFiles‚Äô window. If you click on it, you will see the cell types and their corresponding marker genes, satisfying your chosen conditions.</p>

<blockquote class="tip">
  <div class="box-title tip-title" id="tip-marker-genes-file"><button class="gtn-boxify-button tip" type="button" aria-controls="tip-marker-genes-file-contents" aria-expanded="true" aria-label="Toggle tip box: Marker genes file"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden"></span> Tip: Marker genes file<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Note that you can use the above block of code to generate file with the marker genes for unannotated CDS object to help you identify and check specifically expressed genes ‚Äì you‚Äôd only have to change <code class="language-plaintext highlighter-rouge">group_cells_by</code> parameter from ‚Äúcell_type‚Äù to ‚Äúcluster‚Äù.</p>
</blockquote>

<blockquote class="tip">
  <div class="box-title tip-title" id="tip-only-for-users-of-local-rstudio"><button class="gtn-boxify-button tip" type="button" aria-controls="tip-only-for-users-of-local-rstudio-contents" aria-expanded="true" aria-label="Toggle tip box: Only for users of local RStudio"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden"></span> Tip: Only for users of local RStudio<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>If you are working in RStudio locally, you might want to try a great function <code class="language-plaintext highlighter-rouge">choose_cells()</code>, which allows you to make a subset of the CDS object containing only cells of interest to investigate certain clusters more in-depth. It only works in interactive mode, so can be only used locally - when you call it, then a pop-up window will appear where you can choose cells to subset.</p>
  <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create a CDS subset</span><span class="w">
</span><span class="n">cds_subset</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">choose_cells</span><span class="p">(</span><span class="n">cds_clustered</span><span class="p">)</span><span class="w">
</span></code></pre></div>  </div>
  <p>Now the chosen cluster is stored as a separate CDS object and you can analyse it independently, using the methods described above.</p>

</blockquote>

<h1 id="trajectory-inference">Trajectory inference</h1>
<p>It‚Äôs time to perform trajectory analysis! First, let‚Äôs learn the trajectory graph. With an argument <code class="language-plaintext highlighter-rouge">use_partition</code> we can specify if we want to learn a disjoint graph (value TRUE - default) in each partition, or to learn a single graph (value FALSE) across all partitions. The thing is, we can visualise the cells in pseudotime only if they belong to one partition. This is why it is important to make sure that all the cells that you want to analyse in pseudotime belong to one partition.</p>

<p>In one of the previous sections we‚Äôve already prepared the partitions for trajectory inference - we assigned all the cells of interest into one partition by changing the q-value. As a result, we got two partitions ‚Äì one containing only the cells that we labeled as ‚ÄòUnknown‚Äô and another including all other cells. That is a perfect assignment ‚Äì we‚Äôd like to focus only on maturation of T-cells, so we don‚Äôt want to connect those two partitions (therefore we specify <code class="language-plaintext highlighter-rouge">use_partition=TRUE</code> to get a disjoint graph) and we will work <span class="notranslate">downstream</span> only on the graph going through annotated T-cells.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># learn trajectory graph</span><span class="w">
</span><span class="n">cds_trajectory</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">learn_graph</span><span class="p">(</span><span class="n">cds_annotated</span><span class="p">,</span><span class="w"> </span><span class="n">use_partition</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># visualise the learned trajectory</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_trajectory</span><span class="p">,</span><span class="w">
           </span><span class="n">color_cells_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cell_type"</span><span class="p">,</span><span class="w">
           </span><span class="n">label_cell_groups</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">label_groups_by_cluster</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">label_leaves</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">label_branch_points</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<figure id="figure-15"><img src="../../images/scrna-casestudy-monocle/learned_trajectory_r.png" alt="Learned trajectory graph connecting all the annotated clusters except the ‚ÄòUnknown‚Äô group of cells." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 15:</span> Learned trajectory graph.</figcaption></figure>

<p>We have to tell Monocle where to start ordering the cells, ie. when we expect the analysed biological process to begin. Thanks to our biological knowledge, we know that the beginning of the trajectory should be at DN cluster. 
There are a couple of ways to specify the root cells:</p>

<ol>
  <li>Use <code class="language-plaintext highlighter-rouge">root_pr_nodes</code> argument in <code class="language-plaintext highlighter-rouge">order_cells()</code> function.</li>
</ol>

<p>To find the names of the principal points, you have to plot the learned trajectory again, specifying <code class="language-plaintext highlighter-rouge">label_principal_points = TRUE</code></p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># specifying root cells: `root_pr_nodes` argument - check the principal points</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_trajectory</span><span class="p">,</span><span class="w">
          </span><span class="n">color_cells_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cell_type"</span><span class="p">,</span><span class="w">
          </span><span class="n">label_cell_groups</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
          </span><span class="n">label_groups_by_cluster</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
          </span><span class="n">label_leaves</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
          </span><span class="n">label_branch_points</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
          </span><span class="n">label_principal_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">       </span><span class="c1"># set this to TRUE</span><span class="w">
          </span><span class="n">graph_label_size</span><span class="o">=</span><span class="m">3</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>You can see now the principal points and their labels in the form <code class="language-plaintext highlighter-rouge">Y_number</code>. Pick the principal point in the cluster that you expect to be the beginning of the trajectory and type its name in the <code class="language-plaintext highlighter-rouge">root_pr_nodes</code> argument when calling <code class="language-plaintext highlighter-rouge">order_cells()</code> function.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># specifying root cells: `root_pr_nodes` argument - use the relevant principal point</span><span class="w">
</span><span class="n">cds_order_1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">order_cells</span><span class="p">(</span><span class="n">cds_trajectory</span><span class="p">,</span><span class="w"> </span><span class="n">root_pr_nodes</span><span class="o">=</span><span class="s1">'Y_14'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>There is also a helper function to identify the root principal points based on the annotated cell types. This function uses <code class="language-plaintext highlighter-rouge">pr_graph_cell_proj_closest_vertex</code> which is just a matrix with a single column that stores for each cell, the ID of the principal graph node it‚Äôs closest to.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># a helper function to identify the root principal points</span><span class="w">
</span><span class="n">get_correct_root_state</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">cds</span><span class="p">,</span><span class="w"> </span><span class="n">cell_phenotype</span><span class="p">,</span><span class="w"> </span><span class="n">root_type</span><span class="p">){</span><span class="w">
      </span><span class="n">cell_ids</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">pData</span><span class="p">(</span><span class="n">cds</span><span class="p">)[,</span><span class="w"> </span><span class="n">cell_phenotype</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">root_type</span><span class="p">)</span><span class="w">
        
      </span><span class="n">closest_vertex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cds</span><span class="o">@</span><span class="n">principal_graph_aux</span><span class="p">[[</span><span class="s2">"UMAP"</span><span class="p">]]</span><span class="o">$</span><span class="n">pr_graph_cell_proj_closest_vertex</span><span class="w">
      </span><span class="n">closest_vertex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">closest_vertex</span><span class="p">[</span><span class="n">colnames</span><span class="p">(</span><span class="n">cds</span><span class="p">),</span><span class="w"> </span><span class="p">])</span><span class="w">
      </span><span class="n">root_pr_nodes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">igraph</span><span class="o">::</span><span class="n">V</span><span class="p">(</span><span class="n">principal_graph</span><span class="p">(</span><span class="n">cds</span><span class="p">)[[</span><span class="s2">"UMAP"</span><span class="p">]])</span><span class="o">$</span><span class="n">name</span><span class="p">[</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">names</span><span class="w">
                                                                    </span><span class="p">(</span><span class="n">which.max</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="n">closest_vertex</span><span class="p">[</span><span class="n">cell_ids</span><span class="p">,]))))]</span><span class="w">       
      </span><span class="n">root_pr_nodes</span><span class="w">
      </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># call the function to automatically find the node in the principal graph where our DN cells reside</span><span class="w">
</span><span class="n">DN_node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_correct_root_state</span><span class="p">(</span><span class="n">cds_trajectory</span><span class="p">,</span><span class="w"> </span><span class="n">cell_phenotype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'cell_type'</span><span class="p">,</span><span class="w"> </span><span class="s2">"DN"</span><span class="p">)</span><span class="w">

</span><span class="n">DN_node_id</span><span class="w">      </span><span class="c1"># check the node found</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># order cells using the helper function output</span><span class="w">
</span><span class="n">cds_order_1_helper</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">order_cells</span><span class="p">(</span><span class="n">cds_trajectory</span><span class="p">,</span><span class="w"> </span><span class="n">root_pr_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DN_node_id</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<ol>
  <li>Use <code class="language-plaintext highlighter-rouge">root_cells</code> argument in <code class="language-plaintext highlighter-rouge">order_cells()</code> function.</li>
</ol>

<p>Specify a vector of starting cell IDs. You can provide only one cell as well as all cells of a given type.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># find the names of all cells belonging to a certain type, identified as a beginning of a trajectory</span><span class="w">
</span><span class="n">starting_cell_type</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'DN'</span><span class="w">
</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">which</span><span class="p">(</span><span class="n">cds_trajectory</span><span class="o">@</span><span class="n">colData</span><span class="o">$</span><span class="n">cell_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">starting_cell_type</span><span class="p">)</span><span class="w">
</span><span class="n">DN_cells</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colnames</span><span class="p">(</span><span class="n">cds_trajectory</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># alte<span class="notranslate">rna</span>tively, if you work on unannotated data, you can use the number of the cluster that should be used as the beginning of the trajectory and pass it in the ‚Äòroot_cells‚Äô argument</span><span class="w">
</span><span class="n">starting_cluster</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colnames</span><span class="p">(</span><span class="n">cds_trajectory</span><span class="p">[,</span><span class="n">clusters</span><span class="p">(</span><span class="n">cds_trajectory</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">4</span><span class="p">])</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># order cells </span><span class="w">
</span><span class="n">cds_order_2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">order_cells</span><span class="p">(</span><span class="n">cds_trajectory</span><span class="p">,</span><span class="w"> </span><span class="n">root_cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DN_cells</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<blockquote class="tip">
  <div class="box-title tip-title" id="tip-only-for-users-of-local-rstudio-1"><button class="gtn-boxify-button tip" type="button" aria-controls="tip-only-for-users-of-local-rstudio-1-contents" aria-expanded="true" aria-label="Toggle tip box: Only for users of local RStudio"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden"></span> Tip: Only for users of local RStudio<span role="button" class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>If you are working in RStudio locally, you can use <code class="language-plaintext highlighter-rouge">order_cells()</code> function in the interactive mode. The pop-up window should appear and then you can simply select root nodes in the cluster with the cell type identified as the beginning of the trajectory.</p>

  <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># specifying root cells: pop up window</span><span class="w">
</span><span class="n">cds_order_1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">order_cells</span><span class="p">(</span><span class="n">cds_trajectory</span><span class="p">)</span><span class="w">
</span></code></pre></div>  </div>

</blockquote>

<p>You can use any <code class="language-plaintext highlighter-rouge">cds_order</code> object for the <span class="notranslate">downstream</span> analysis. Let‚Äôs pick one and assign it to an object with a shorter and more general name.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cds_order</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cds_order_1_helper</span><span class="w">
</span></code></pre></div></div>

<p>The function <code class="language-plaintext highlighter-rouge">order_cells()</code> calculates pseudotime for each cell, so we can now visualise the T-cell maturation process in pseudotime! Additionally, we can access it and store in our CDS object for further analysis.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot cells in pseudotime</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_order</span><span class="p">,</span><span class="w">
           </span><span class="n">color_cells_by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"pseudotime"</span><span class="p">,</span><span class="w">
           </span><span class="n">label_cell_groups</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">label_leaves</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w">
           </span><span class="n">label_branch_points</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># access pseudotime calculated for each cell and store it alongside cell metadata </span><span class="w">
</span><span class="n">pseudotime</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pseudotime</span><span class="p">(</span><span class="n">cds_order</span><span class="p">)</span><span class="w"> 	
</span><span class="n">cds_order</span><span class="o">@</span><span class="n">colData</span><span class="o">$</span><span class="n">pseudotime</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pseudotime</span><span class="w"> 		 
</span></code></pre></div></div>

<figure id="figure-16"><img src="../../images/scrna-casestudy-monocle/pseudotime_r.png" alt="Plot of the cells ordered in pseudotime. The trajectory starts at double negative cells (ie. pseudotime = 0) which are coloured blue, then goes through double positive (middle T-cells), gradually changing colour from purple to pink, then double positive (late T-cells) are coloured orange and the trajectory ends at T-mature cells, which are coloured yellow." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 16:</span> Cells ordered in pseudotime.</figcaption></figure>

<p>We can now see how our hard work has come together to give a final pseudotime trajectory analysis, which starts at double negative cells, then gently switches to double positives: from middle to late T-cells, and ends up on mature T-cells.</p>

<h1 id="differential-expression-analysis">Differential <span class="notranslate">expression</span> analysis</h1>
<p>There are two approaches for more advanced differential analysis in Monocle:</p>
<ul>
  <li>Regression analysis: using <code class="language-plaintext highlighter-rouge">fit_models()</code>, you can evaluate whether each gene depends on variables such as time, treatments, etc.</li>
  <li>Graph-autocorrelation analysis: using <code class="language-plaintext highlighter-rouge">graph_test()</code>, you can find genes that vary over a trajectory or between clusters.</li>
</ul>

<p>In this section, for some examples, we will work on the subset of our CDS object because the computation time for the whole dataset would take quite some time. Let‚Äôs make the subset CDS containing the information about the genes listed in the table in the previous section, so instead having 15395 elements, it will have only 7.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># make the subset CDS</span><span class="w">
</span><span class="n">test_genes</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'Il2ra'</span><span class="p">,</span><span class="s1">'Cd8b1'</span><span class="p">,</span><span class="s1">'Cd8a'</span><span class="p">,</span><span class="s1">'Cd4'</span><span class="p">,</span><span class="s1">'Itm2a'</span><span class="p">,</span><span class="s1">'Aif1'</span><span class="p">,</span><span class="s1">'Hba-a1'</span><span class="p">)</span><span class="w">
</span><span class="n">cds_subset</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cds_order</span><span class="p">[</span><span class="n">rowData</span><span class="p">(</span><span class="n">cds_order</span><span class="p">)</span><span class="o">$</span><span class="n">gene_short_name</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">test_genes</span><span class="p">,]</span><span class="w">
</span></code></pre></div></div>

<h2 id="some-more-plotting">Some more plotting</h2>
<p>Monocle also provides some easy ways to plot the <span class="notranslate">expression</span> of a small set of genes grouped by the factors you use during differential analysis.
For example <code class="language-plaintext highlighter-rouge">plot_genes_violin()</code> allows us to create violin plots which are quite common in the field. Therefore let‚Äôs visualise how the gene <span class="notranslate">expression</span> changes between the cell types.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># produce violin plots</span><span class="w">
</span><span class="n">plot_genes_violin</span><span class="p">(</span><span class="n">cds_subset</span><span class="p">,</span><span class="w"> </span><span class="n">group_cells_by</span><span class="o">=</span><span class="s2">"cell_type"</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<figure id="figure-17"><img src="../../images/scrna-casestudy-monocle/violin_plots.png" alt=" Violin plots of the expression of the specified genes in each assigned cell type. The trends are consistent with the previous biological interpretation and assignment." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 17:</span>  Violin plots of the <span class="notranslate">expression</span> of the specified genes in each assigned cell type.</figcaption></figure>

<p>When analysing the above violin plots, we will realise that the results are consistent with the detailed analysis in the previous tutorials, as well as findings in current tutorial.</p>

<p>Another great function <code class="language-plaintext highlighter-rouge">plot_genes_in_pseudotime()</code> takes a small set of genes and shows their dynamics as a function of pseudotime.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot_genes_in_pseudotime</span><span class="p">(</span><span class="n">cds_subset</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="o">=</span><span class="s2">"cell_type"</span><span class="p">,</span><span class="w"> </span><span class="n">min_expr</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<figure id="figure-18"><img src="../../images/scrna-casestudy-monocle/genes_in_pseudotime.png" alt="On the left hand side scatter plots of expression of the specified genes in pseudotime. On the right hand side also the expression of specified genes as a function of pseudotime but shown with the cell type data superimposed. Again the trends are consistent with the previous biological interpretation and assignment. " loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 18:</span>  A visualisation of how specified genes change in the pseudotime.</figcaption></figure>

<h2 id="regression-analysis---advanced">Regression analysis - advanced</h2>
<p>We will use a function which fits a generalized linear model for each gene in a CDS object. We have to specify the model formula which is any term that exists as a column in <code class="language-plaintext highlighter-rouge">colData()</code>. We want to test genes that differ between cell types and batches, so we will use ‚Äú~cell_type + batch‚Äù argument. Then, we extract a table of coefficients from each model. <code class="language-plaintext highlighter-rouge">coefficient_table()</code> tests whether each coefficient differs significantly from zero under the <a href="https://en.wikipedia.org/wiki/Wald_test">Wald test</a>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fit a generalized linear model for each gene</span><span class="w">
</span><span class="n">gene_fits</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fit_models</span><span class="p">(</span><span class="n">cds_subset</span><span class="p">,</span><span class="w"> </span><span class="n">model_formula_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"~cell_type + batch"</span><span class="p">)</span><span class="w"> 
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># extract a table of coefficients</span><span class="w">
</span><span class="n">fit_coefs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">coefficient_table</span><span class="p">(</span><span class="n">gene_fits</span><span class="p">)</span><span class="w"> 	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># preview the content of 'fit_coefs'</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">fit_coefs</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>If you inspect the <code class="language-plaintext highlighter-rouge">fit_coefs</code> object, you will notice that the table includes one row for each term of each gene‚Äôs model. We generally don‚Äôt care about the intercept term, so we can filter it out. In this way, we will be able to control for the chosen factors. To focus on only one variable, you have to check the <code class="language-plaintext highlighter-rouge">term</code> column in the <code class="language-plaintext highlighter-rouge">fit_coefs</code> and pass this as an argument for filtering. Then, you should also filter the results with q_value &lt; 0.05 to control the false discovery rate.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># filter out Intercept term</span><span class="w">
</span><span class="n">no_intercept_coefs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fit_coefs</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="n">filter</span><span class="p">(</span><span class="n">term</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"(Intercept)"</span><span class="p">)</span><span class="w"> 	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># extract results for DP-M1 cells only</span><span class="w">
</span><span class="n">DP_M1_coefs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fit_coefs</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="n">filter</span><span class="p">(</span><span class="n">term</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"cell_typeDP-M1"</span><span class="p">)</span><span class="w"> 	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># control the false discovery rate and choose only several variables to store</span><span class="w">
</span><span class="n">DP_M1_coefs_filtered</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DP_M1_coefs</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="n">filter</span><span class="w"> </span><span class="p">(</span><span class="n">q_value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">gene_short_name</span><span class="p">,</span><span class="w"> </span><span class="n">term</span><span class="p">,</span><span class="w"> </span><span class="n">q_value</span><span class="p">,</span><span class="w"> </span><span class="n">estimate</span><span class="p">)</span><span class="w">		
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># view the resulting table</span><span class="w">
</span><span class="n">DP_M1_coefs_filtered</span><span class="w">
</span></code></pre></div></div>
<p>The resulting table shows the genes that differ depending on the chosen term. Maybe this function is not very helpful in the case of our dataset, but may be useful when analysing unannotated data or choosing another term from <code class="language-plaintext highlighter-rouge">colData()</code>.</p>

<h2 id="graph-autocorrelation-analysis---advanced">Graph-autocorrelation analysis - advanced</h2>
<p>Alongside regression analysis, Monocle also provides another way of finding genes that vary between groups of cells. The function <code class="language-plaintext highlighter-rouge">graph_test()</code> uses a statistic from spatial autocorrelation analysis called <a href="https://en.wikipedia.org/wiki/Moran%27s_I">Moran‚Äôs I</a>, which <span class="citation"><a href="#Cao_2019">Cao <i>et al.</i> 2018</a></span> showed to be effective in finding genes that vary in <span class="notranslate">single-cell</span> <span class="notranslate">RNA</span>-seq datasets. Let‚Äôs try to perform this step on our full dataset (be patient!).</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># run autocorrelation test</span><span class="w">
</span><span class="n">graph_test_res</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">graph_test</span><span class="p">(</span><span class="n">cds_order</span><span class="p">,</span><span class="w"> </span><span class="n">neighbor_graph</span><span class="o">=</span><span class="s2">"knn"</span><span class="p">,</span><span class="w"> </span><span class="n">cores</span><span class="o">=</span><span class="m">8</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The output data frame has a bunch of statistical values that you can use to rank the genes by, for example <code class="language-plaintext highlighter-rouge">morans_I</code> column, which ranges from -1 to +1. A value of 0 indicates no effect, while +1 indicates perfect positive autocorrelation and suggests that nearby cells have very similar values of a gene‚Äôs <span class="notranslate">expression</span>.</p>

<p>We will now try to associate genes with clusters by grouping genes into modules that have similar patterns of <span class="notranslate">expression</span>. You can call <code class="language-plaintext highlighter-rouge">find_gene_modules()</code>, which essentially runs UMAP on the genes (as opposed to the cells) and then groups them into modules using Louvain community analysis.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># get gene IDs for which q-value &lt; 0.05</span><span class="w">
</span><span class="n">pr_deg_ids</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">row.names</span><span class="p">(</span><span class="n">subset</span><span class="p">(</span><span class="n">graph_test_res</span><span class="p">,</span><span class="w"> </span><span class="n">q_value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0.05</span><span class="p">))</span><span class="w"> 	
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># group genes into modules</span><span class="w">
</span><span class="n">gene_module_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">find_gene_modules</span><span class="p">(</span><span class="n">cds_order</span><span class="p">[</span><span class="n">pr_deg_ids</span><span class="p">,],</span><span class="w"> </span><span class="n">resolution</span><span class="o">=</span><span class="m">1e-2</span><span class="p">)</span><span class="w"> 	
</span></code></pre></div></div>
<p>Now we can show the aggregate <span class="notranslate">expression</span> of all genes in each module across all the clusters. Monocle provides a simple utility function called <code class="language-plaintext highlighter-rouge">aggregate_gene_<span class="notranslate">expression</span></code> for this purpose:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># aggregate <span class="notranslate">expression</span> of genes in each module</span><span class="w">
</span><span class="n">cell_group_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="o">::</span><span class="n">tibble</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">row.names</span><span class="p">(</span><span class="n">colData</span><span class="p">(</span><span class="n">cds_order</span><span class="p">)),</span><span class="w"> 
                                </span><span class="n">cell_group</span><span class="o">=</span><span class="n">clusters</span><span class="p">(</span><span class="n">cds_order</span><span class="p">)[</span><span class="n">colnames</span><span class="p">(</span><span class="n">cds_order</span><span class="p">)])</span><span class="w">
</span><span class="n">agg_mat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">aggregate_gene_<span class="notranslate">expression</span></span><span class="p">(</span><span class="n">cds_order</span><span class="p">,</span><span class="w"> </span><span class="n">gene_module_df</span><span class="p">,</span><span class="w"> </span><span class="n">cell_group_df</span><span class="p">)</span><span class="w">
</span><span class="n">row.names</span><span class="p">(</span><span class="n">agg_mat</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stringr</span><span class="o">::</span><span class="n">str_c</span><span class="p">(</span><span class="s2">"Module "</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="p">(</span><span class="n">agg_mat</span><span class="p">))</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">agg_mat</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stringr</span><span class="o">::</span><span class="n">str_c</span><span class="p">(</span><span class="s2">"Cluster "</span><span class="p">,</span><span class="w"> </span><span class="n">colnames</span><span class="p">(</span><span class="n">agg_mat</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>
<p>We can now use this data to create a heatmap. Don‚Äôt worry if yours look a little bit different that the one shown in this tutorial. The general features should be maintained though.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create a heatmap</span><span class="w">
</span><span class="n">pheatmap</span><span class="o">::</span><span class="n">pheatmap</span><span class="p">(</span><span class="n">agg_mat</span><span class="p">,</span><span class="w"> </span><span class="n">cluster_rows</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">cluster_cols</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
                   </span><span class="n">scale</span><span class="o">=</span><span class="s2">"column"</span><span class="p">,</span><span class="w"> </span><span class="n">clustering_method</span><span class="o">=</span><span class="s2">"ward.D2"</span><span class="p">,</span><span class="w">
                   </span><span class="n">fontsize</span><span class="o">=</span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<figure id="figure-19"><img src="../../images/scrna-casestudy-monocle/heatmap.png" alt="A heatmap showing modules of co-regulated genes across the clusters. Modules listed vertically while clusters horizontally. Some modules are highly specific to certain partitions of cells, while others are shared across multiple partitions." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 19:</span> Heatmap showing modules of co-regulated genes across the clusters.</figcaption></figure>

<p>You can also visualise the modules using <code class="language-plaintext highlighter-rouge">plot_cells()</code> function. We‚Äôve chosen some modules to see how the differences on a heatmap correlate with the <span class="notranslate">expression</span> shown on our starting plot.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see the chosen modules across the whole sample</span><span class="w">
</span><span class="n">plot_cells</span><span class="p">(</span><span class="n">cds_order</span><span class="p">,</span><span class="w"> 
           </span><span class="n">genes</span><span class="o">=</span><span class="n">gene_module_df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="n">filter</span><span class="p">(</span><span class="n">module</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">40</span><span class="p">,</span><span class="w"> </span><span class="m">39</span><span class="p">,</span><span class="w"> </span><span class="m">36</span><span class="p">,</span><span class="w"> </span><span class="m">17</span><span class="p">)),</span><span class="w">
           </span><span class="n">group_cells_by</span><span class="o">=</span><span class="s2">"cluster"</span><span class="p">,</span><span class="w">
           </span><span class="n">color_cells_by</span><span class="o">=</span><span class="s2">"cluster"</span><span class="p">,</span><span class="w">
           </span><span class="n">show_trajectory_graph</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<figure id="figure-20"><img src="../../images/scrna-casestudy-monocle/modules_plot.png" alt="Plots showing expression of the genes belonging to specified modules across whole sample. Module 19 highly expressed in cluster 2 but also low expression thtoughout the sample, module 38 low expression but throughout the sample, module 41 highly expressed in cluster 5 only, module 42 almost no expression, except cluster 6." loading="lazy" /><figcaption><span class="figcaption-prefix">Figure 20:</span> Plots of <span class="notranslate">expression</span> of the genes belonging to specified modules across whole sample.</figcaption></figure>

<p>With the visualisation methods above, you can now come back to the generated data frame <code class="language-plaintext highlighter-rouge">gene_module_df</code>, filter genes that belong to the module of interest and check their functions to get some more evidence for the correct biological interpretation.</p>

<h1 id="3d-plotting">3D plotting</h1>
<p>Let‚Äôs have some fun at the end! That was quite a long and insightful analysis ‚Äì you definitely deserve to look at some nice, rotatable, cool plot now! 
Essentially the <span class="notranslate">workflow</span> is the same as we followed in two dimensions. The crucial part is to specify the dimensionality of the reduced space with the <code class="language-plaintext highlighter-rouge">max_components</code> parameter in <code class="language-plaintext highlighter-rouge">reduce_dimension()</code> function. The default is 2, but if we want to see our data in 3D, we will change that value to 3. From there, you can just repeat the next steps in 3D‚Ä¶ or just reward yourself for completing this tutorial by toggling this beautiful 3D plot!</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># reduce dimension to 3D</span><span class="w">
</span><span class="n">cds_3d</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">reduce_dimension</span><span class="p">(</span><span class="n">cds_order</span><span class="p">,</span><span class="w"> </span><span class="n">preprocess_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Aligned'</span><span class="p">,</span><span class="w"> </span><span class="n">max_components</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see the resulting 3D plot</span><span class="w">
</span><span class="n">plot_cells_3d</span><span class="p">(</span><span class="n">cds_3d</span><span class="p">,</span><span class="w"> </span><span class="n">color_cells_by</span><span class="o">=</span><span class="s2">"cell_type"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h1 id="conclusion">Conclusion</h1>

<p>If you‚Äôre following the Case Study tutorials from the beginning, you have already experienced what it‚Äôs like to analyse and question a dataset, potentially without clear cut-offs or clear answers. The <a href="/training-material/topics/single-cell/tutorials/scrna-case_monocle3-trajectories/tutorial.html">Monocle in <span class="notranslate">Galaxy</span> tutorial</a> was focused more on explaining each step of the trajectory analysis and interpreting the results in the biological context. The current tutorial aims at showing the variety of methods that can be used when <span class="notranslate">Galaxy</span>‚Äôs Monocle tools are not enough. It shows the potential of batch correction, differential <span class="notranslate">expression</span> analysis and flexibility when using different functions. It‚Äôs also a guide for those who would like to understand what is happening ‚Äòbehind the scenes‚Äô when clicking on <span class="notranslate">Galaxy</span> buttons.</p>


                
                <blockquote class="key_points">
                    <div class="box-title" aria-label="key-points box"><i class="fas fa-key" aria-hidden="true"></i> Key points</div>
                    <ul>
                        
                        <li><p>Being able to switch between Galaxy and R when using Monocle is very useful, particularly when you need to modify the CDS object manually.</p>
</li>
                        
                        <li><p>Monocle3 in R gives more flexibility when it comes to differential expression analysis and plotting, but Galaxy offers great reproducibility and ease of analysis.</p>
</li>
                        
                        <li><p>Comparing the output of several different methods applied on the same dataset might be useful to confirm the results, to ensure that the findings are reliable and even sometimes to find a new piece of information.</p>
</li>
                        
                    </ul>
                </blockquote>
                

                <h1>Frequently Asked Questions</h1>
                Have questions about this tutorial? Check out the <a href="faqs/">tutorial FAQ page</a> or the  <a href="/training-material/topics/single-cell/faqs/">FAQ page for the Single Cell topic</a> to see if your question is listed there.
                If not, please ask your question on the <a href="https://gitter.im/Galaxy-Training-Network/Lobby">GTN Gitter Channel</a> or the
                <a href="https://help.galaxyproject.org">Galaxy Help Forum</a>

                

                
                <h1 data-toc-skip>Useful literature</h1>
                <p>Further information, including links to documentation and original publications, regarding the tools, analysis techniques and the interpretation of results described in this tutorial can be found <a href="/training-material/topics/single-cell#references">here</a>.</p>
                


                
                <h1 id="bibliography">References</h1>
                <ol class="bibliography"><li id="Levine_2015">Levine, J. H., E. F. Simonds, S. C. Bendall, K. L. Davis, E.-ad¬†D. Amir <i>et al.</i>, 2015 <b>Data-Driven Phenotypic Dissection of AML Reveals Progenitor-like Cells that Correlate with Prognosis</b>. Cell 162: 184‚Äì197. <a href="https://doi.org/10.1016/j.cell.2015.05.047">10.1016/j.cell.2015.05.047</a></li>
<li id="Bacon2018">Bacon, W. A., R. S. Hamilton, Z. Yu, J. Kieckbusch, D. Hawkes <i>et al.</i>, 2018 <b>Single-Cell Analysis Identifies Thymic Maturation Delay in Growth-Restricted Neonatal Mice</b>. Frontiers in Immunology 9: <a href="https://doi.org/10.3389/fimmu.2018.02523">10.3389/fimmu.2018.02523</a></li>
<li id="Cao_2019">Cao, J., M. Spielmann, X. Qiu, X. Huang, D. M. Ibrahim <i>et al.</i>, 2018 <b>The single-cell transcriptional landscape of mammalian organogenesis</b>. Nature 566: 496‚Äì502. <a href="https://doi.org/10.1038/s41586-019-0969-x">10.1038/s41586-019-0969-x</a> <a href="https://10.1038/s41586-019-0969-x">https://10.1038/s41586-019-0969-x</a></li>
<li id="Haghverdi_2018">Haghverdi, L., A. T. L. Lun, M. D. Morgan, and J. C. Marioni, 2018 <b>Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors</b>. Nature Biotechnology 36: 421‚Äì427. <a href="https://doi.org/10.1038/nbt.4091">10.1038/nbt.4091</a></li>
<li id="Traag_2019">Traag, V. A., L. Waltman, and N. J. van Eck, 2019 <b>From Louvain to Leiden: guaranteeing well-connected communities</b>. Sci Rep 9: <a href="https://doi.org/10.1038/s41598-019-41695-z">10.1038/s41598-019-41695-z</a></li>
<li id="Wolf_2019">Wolf, F. A., F. K. Hamey, M. Plass, J. Solana, J. S. Dahlin <i>et al.</i>, 2019 <b>PAGA: graph abstraction reconciles clustering with trajectory inference through a topology preserving map of single cells</b>. Genome Biol 20: <a href="https://doi.org/10.1186/s13059-019-1663-x">10.1186/s13059-019-1663-x</a></li></ol>
                

                

                <h1>Feedback</h1>
                <p class="text-muted">Did you use this material as an instructor? Feel free to give us feedback on <a href="https://github.com/galaxyproject/training-material/issues/1452">how it went</a>.
                <br>Did you use this material as a learner or student? Click the form below to leave feedback.<i class="fas fa-hand-point-down"></i>
                </p>

                <div id="feedback-button">
                    <img src="/training-material/shared/images/feedback.png" title="Click to activate" alt="Click here to load Google feedback frame" />
                </div>
                <div id="feedback-form">
                </div>
                <script type="text/javascript">
                    (function (window, document) {
                        function onDocumentReady(fn) {
                            if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
                                fn();
                            } else {
                                document.addEventListener('DOMContentLoaded', fn);
                            }
                        }

                        onDocumentReady(function () {
                            $("#feedback-button").click(function(evt){
                                var e = $(evt.target)
                                e.hide();

                                $("#feedback-form").html(`
                                    <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Trajectory Analysis: Monocle3 in R (Single Cell)">Loading...</iframe>
                                `)
                            })
                        });
                    })(window, document);
                </script>

                <h1>Citing this Tutorial</h1>
                <p>
                    <ol>
                        <li id="citation-text">
                            Julia Jakiela,  <b>Trajectory Analysis: Monocle3 in R (Galaxy Training Materials)</b>. <a href="https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html">https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html</a> Online; accessed TODAY
                        </li>
                        <li>
                        Batut et al., 2018 <b>Community-Driven Data Analysis Training for Biology</b> Cell Systems <a href="https://doi.org/10.1016%2Fj.cels.2018.05.012">10.1016/j.cels.2018.05.012</a>
                        </li>
                    </ol>
                </p>

                <!-- collapsible boxcontaining the BibTeX-formatted citation -->
                <blockquote class="details">

                  <div id="citation-bibtex" class="box-title">
                    <button type="button" aria-controls="citation-bibtex" aria-expanded="false" aria-label="Toggle details box: BibTeX for citing this tutorial">
                      <i class="fas fa-info-circle" aria-hidden="true"></i>
                      <span class="visually-hidden"></span> BibTeX<span role="button" class="fold-unfold fa fa-minus-square" aria-hidden="true"></span>
                    </button>
                   </div>
                   <p style="display: none;">

                   <div class="highlighter-rouge"><div class="highlight"><pre class="highlight">


<code id="citation-code">@misc{single-cell-scrna-case_monocle3-rstudio,
author = "Julia Jakiela",
title = "Trajectory Analysis: Monocle3 in R (Galaxy Training Materials)",
year = "",
month = "",
day = ""
url = "\url{https://training.galaxyproject.org/training-material/topics/single-cell/tutorials/scrna-case_monocle3-rstudio/tutorial.html}",
note = "[Online; accessed TODAY]"
}
@article{Hiltemann_2023,
	doi = {10.1371/journal.pcbi.1010752},
	url = {https://doi.org/10.1371%2Fjournal.pcbi.1010752},
	year = 2023,
	month = {jan},
	publisher = {Public Library of Science ({PLoS})},
	volume = {19},
	number = {1},
	pages = {e1010752},
	author = {Saskia Hiltemann and Helena Rasche and Simon Gladman and Hans-Rudolf Hotz and Delphine Larivi{\`{e}}re and Daniel Blankenberg and Pratik D. Jagtap and Thomas Wollmann and Anthony Bretaudeau and Nadia Gou{\'{e}} and Timothy J. Griffin and Coline Royaux and Yvan Le Bras and Subina Mehta and Anna Syme and Frederik Coppens and Bert Droesbeke and Nicola Soranzo and Wendi Bacon and Fotis Psomopoulos and Crist{\'{o}}bal Gallardo-Alba and John Davis and Melanie Christine F√∂ll and Matthias Fahrner and Maria A. Doyle and Beatriz Serrano-Solano and Anne Claire Fouilloux and Peter van Heusden and Wolfgang Maier and Dave Clements and Florian Heyl and Bj√∂rn Gr√ºning and B{\'{e}}r{\'{e}}nice Batut and},
	editor = {Francis Ouellette},
	title = {Galaxy Training: A powerful framework for teaching!},
	journal = {PLoS Comput Biol} Computational Biology}
}
</code>
                   </pre></div></div>
                   </p>
                </blockquote>

                
                

                


<script type="text/javascript">
// update the date on load, or leave fallback of 'today'
d = new Date();
document.getElementById("citation-code").innerHTML = document.getElementById("citation-code").innerHTML.replace("TODAY", d.toDateString());
document.getElementById("citation-text").innerHTML = document.getElementById("citation-text").innerHTML.replace("TODAY", d.toDateString());
</script>

                <i class="far fa-thumbs-up" aria-hidden="true"></i> Congratulations on successfully completing this tutorial!

                

                

            </div>
        </div>
    </div>
</section>
<br/>
<br/>
<br/>

        </div>
        
        <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
        <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
        <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
        <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
        <script type="text/javascript" src="/training-material/assets/js/main.js"></script>
        <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
        <script type="text/javascript">
        var snippets=document.querySelectorAll('div.highlight');
        [].forEach.call(snippets,function(snippet){
            snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
        });

        var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
            target:function(trigger){return trigger.nextElementSibling;
        }});
        </script>
        

        <script type="text/javascript">
            if(window.location.hostname === "galaxyproject.github.io") {
                // Redirect
                var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
                $('div.container.main-content').prepend("<div class='alert alert-warning'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

                window.setTimeout(function(){
                    window.location.href = redirect;
                }, 5000)

            }
        </script>
    </body>
</html>